<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3U 与 TXT 格式转换器</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f7fa;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .description {
            color: #7f8c8d;
            font-size: 16px;
        }
        
        .formats-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .format-section {
            flex: 1;
            min-width: 300px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 20px;
        }
        
        .format-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .format-title h2 {
            color: #2c3e50;
            font-size: 20px;
        }
        
        .format-badge {
            display: inline-block;
            background-color: #3498db;
            color: white;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 10px;
        }
        
        .m3u-badge {
            background-color: #3498db;
        }
        
        .txt-badge {
            background-color: #2ecc71;
        }
        
        .section-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .section-actions button {
            padding: 8px 15px;
            font-size: 14px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .import-btn {
            background-color: #3498db;
            color: white;
        }
        
        .import-btn:hover {
            background-color: #2980b9;
        }
        
        .export-btn {
            background-color: #2ecc71;
            color: white;
        }
        
        .export-btn:hover {
            background-color: #27ae60;
        }
        
        textarea {
            width: 100%;
            height: 300px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 15px;
            background-color: #f9f9f9;
        }
        
        .textarea-container {
            position: relative;
        }
        
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 6px 12px;
            background-color: #9b59b6;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: none;
            z-index: 10;
        }
        
        .copy-btn:hover {
            background-color: #8e44ad;
        }
        
        .copy-btn.show {
            display: block;
        }
        
        .copy-success {
            position: absolute;
            top: 10px;
            right: 100px;
            background-color: #2ecc71;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 13px;
            display: none;
            z-index: 10;
        }
        
        .copy-success.show {
            display: block;
            animation: fadeOut 2s forwards;
        }
        
        @keyframes fadeOut {
            0% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        .button-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .main-button {
            padding: 12px 25px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .main-button:hover {
            background-color: #2980b9;
        }
        
        .convert-btn {
            background-color: #9b59b6;
        }
        
        .convert-btn:hover {
            background-color: #8e44ad;
        }
        
        .clear-btn {
            background-color: #e74c3c;
        }
        
        .clear-btn:hover {
            background-color: #c0392b;
        }
        
        .format-info {
            background-color: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 12px;
            margin-top: 10px;
            border-radius: 0 4px 4px 0;
            font-size: 14px;
        }
        
        .format-info h4 {
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .format-info ul {
            padding-left: 20px;
        }
        
        .format-info li {
            margin-bottom: 5px;
        }
        
        .instructions {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 20px;
            margin-top: 30px;
        }
        
        .instructions h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .instructions p {
            margin-bottom: 10px;
        }
        
        .instructions code {
            background-color: #f1f1f1;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            color: #7f8c8d;
            font-size: 14px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        
        .file-input {
            display: none;
        }
        
        @media (max-width: 768px) {
            .formats-container {
                flex-direction: column;
            }
            
            .format-section {
                min-width: 100%;
            }
            
            .format-title {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .section-actions {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>M3U 与 TXT 格式转换器</h1>
        <p class="description">在 M3U 格式和 TXT 格式的直播源之间进行相互转换，支持文件导入导出</p>
    </header>
    
    <div class="formats-container">
        <div class="format-section">
            <div class="format-title">
                <div>
                    <h2>M3U 格式</h2>
                    <span class="format-badge m3u-badge">.m3u / .m3u8</span>
                </div>
                <div class="section-actions">
                    <button class="import-btn" id="import-m3u">
                        <span>导入文件</span>
                    </button>
                    <button class="export-btn" id="export-m3u">
                        <span>导出文件</span>
                    </button>
                </div>
            </div>
            <div class="textarea-container">
                <textarea id="m3u-input" placeholder="#EXTM3U
#EXTINF:-1 group-title=&quot;央视&quot;,1CCTV-1HD [1080p]
http://example.com/channel1.m3u8
#EXTINF:-1 group-title=&quot;央视&quot;,2CCTV-1HD [1080p]
http://example.com/channel2.m3u8"></textarea>
                <button class="copy-btn" id="copy-m3u">复制内容</button>
                <div class="copy-success" id="copy-success-m3u">复制成功!</div>
            </div>
            
            <div class="format-info">
                <h4>M3U 格式说明：</h4>
                <ul>
                    <li>以 <code>#EXTM3U</code> 开头作为文件头</li>
                    <li>每个频道由两行组成：信息行和URL行</li>
                    <li>信息行格式：<code>#EXTINF:-1 group-title="组名",频道名称</code></li>
                    <li>URL行是频道的播放地址</li>
                </ul>
            </div>
        </div>
        
        <div class="format-section">
            <div class="format-title">
                <div>
                    <h2>TXT 格式</h2>
                    <span class="format-badge txt-badge">.txt</span>
                </div>
                <div class="section-actions">
                    <button class="import-btn" id="import-txt">
                        <span>导入文件</span>
                    </button>
                    <button class="export-btn" id="export-txt">
                        <span>导出文件</span>
                    </button>
                </div>
            </div>
            <div class="textarea-container">
                <textarea id="txt-input" placeholder="央视,#genre#
1CCTV-1HD [1080p],http://example.com/channel1.m3u8
2CCTV-1HD [1080p],http://example.com/channel2.m3u8"></textarea>
                <button class="copy-btn" id="copy-txt">复制内容</button>
                <div class="copy-success" id="copy-success-txt">复制成功!</div>
            </div>
            
            <div class="format-info">
                <h4>TXT 格式说明：</h4>
                <ul>
                    <li>分组标题格式：<code>组名,#genre#</code></li>
                    <li>每个频道占一行，格式：<code>频道名称,URL</code></li>
                    <li>相同分组的频道放在同一个分组标题下</li>
                    <li>常用于某些直播软件的自定义源格式</li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="button-container">
        <button id="m3u-to-txt" class="main-button convert-btn">
            <span>M3U → TXT</span>
        </button>
        <button id="txt-to-m3u" class="main-button convert-btn">
            <span>TXT → M3U</span>
        </button>
        <button id="clear-all" class="main-button clear-btn">
            <span>清空全部</span>
        </button>
    </div>
    
    <div class="instructions">
        <h3>使用说明</h3>
        <p>1. 在左侧输入 M3U 格式内容，或在右侧输入 TXT 格式内容</p>
        <p>2. 点击转换按钮将一种格式转换为另一种格式</p>
        <p>3. 转换结果会自动显示在对应的文本框中，并显示复制按钮</p>
        <p>4. 点击"导入文件"可以从本地导入 M3U 或 TXT 文件</p>
        <p>5. 点击"导出文件"可以将当前内容保存为文件</p>
        <p>6. 使用"清空全部"按钮清除所有文本框内容</p>
        <p><strong>注意：</strong>TXT 转 M3U 时已修复分组问题，TXT 中的分组信息会正确转换为 M3U 的 group-title。</p>
    </div>
    
    <footer>
        <p>M3U/TXT 格式转换器 &copy; 2023 | 支持标准 M3U 格式和分组 TXT 格式相互转换</p>
    </footer>

    <!-- 隐藏的文件输入元素 -->
    <input type="file" id="file-input-m3u" class="file-input" accept=".m3u,.m3u8,.txt">
    <input type="file" id="file-input-txt" class="file-input" accept=".txt,.m3u,.m3u8">
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const m3uInput = document.getElementById('m3u-input');
            const txtInput = document.getElementById('txt-input');
            const m3uToTxtBtn = document.getElementById('m3u-to-txt');
            const txtToM3uBtn = document.getElementById('txt-to-m3u');
            const clearAllBtn = document.getElementById('clear-all');
            
            // 复制按钮和成功提示
            const copyM3uBtn = document.getElementById('copy-m3u');
            const copyTxtBtn = document.getElementById('copy-txt');
            const copySuccessM3u = document.getElementById('copy-success-m3u');
            const copySuccessTxt = document.getElementById('copy-success-txt');
            
            // 文件导入导出按钮
            const importM3uBtn = document.getElementById('import-m3u');
            const importTxtBtn = document.getElementById('import-txt');
            const exportM3uBtn = document.getElementById('export-m3u');
            const exportTxtBtn = document.getElementById('export-txt');
            
            // 文件输入元素
            const fileInputM3u = document.getElementById('file-input-m3u');
            const fileInputTxt = document.getElementById('file-input-txt');
            
            // 初始化复制按钮状态
            updateCopyButtons();
            
            // 监听输入变化，更新复制按钮状态
            m3uInput.addEventListener('input', updateCopyButtons);
            txtInput.addEventListener('input', updateCopyButtons);
            
            // M3U 转 TXT 格式
            m3uToTxtBtn.addEventListener('click', function() {
                const m3uContent = m3uInput.value.trim();
                if (!m3uContent) {
                    alert('请输入 M3U 格式内容');
                    return;
                }
                
                try {
                    const txtContent = convertM3uToTxt(m3uContent);
                    txtInput.value = txtContent;
                    
                    // 显示复制按钮
                    copyTxtBtn.classList.add('show');
                    
                    // 显示成功提示
                    showSuccessMessage('M3U 格式已成功转换为 TXT 格式');
                } catch (error) {
                    alert('转换失败：' + error.message);
                }
            });
            
            // TXT 转 M3U 格式
            txtToM3uBtn.addEventListener('click', function() {
                const txtContent = txtInput.value.trim();
                if (!txtContent) {
                    alert('请输入 TXT 格式内容');
                    return;
                }
                
                try {
                    const m3uContent = convertTxtToM3u(txtContent);
                    m3uInput.value = m3uContent;
                    
                    // 显示复制按钮
                    copyM3uBtn.classList.add('show');
                    
                    // 显示成功提示
                    showSuccessMessage('TXT 格式已成功转换为 M3U 格式');
                } catch (error) {
                    alert('转换失败：' + error.message);
                }
            });
            
            // 清空所有输入
            clearAllBtn.addEventListener('click', function() {
                if (confirm('确定要清空所有内容吗？')) {
                    m3uInput.value = '';
                    txtInput.value = '';
                    updateCopyButtons();
                }
            });
            
            // 复制 M3U 内容
            copyM3uBtn.addEventListener('click', function() {
                copyToClipboard(m3uInput.value);
                copySuccessM3u.classList.add('show');
                setTimeout(() => {
                    copySuccessM3u.classList.remove('show');
                }, 2000);
            });
            
            // 复制 TXT 内容
            copyTxtBtn.addEventListener('click', function() {
                copyToClipboard(txtInput.value);
                copySuccessTxt.classList.add('show');
                setTimeout(() => {
                    copySuccessTxt.classList.remove('show');
                }, 2000);
            });
            
            // 导入 M3U 文件
            importM3uBtn.addEventListener('click', function() {
                fileInputM3u.click();
            });
            
            fileInputM3u.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    readFile(file, function(content) {
                        m3uInput.value = content;
                        updateCopyButtons();
                        showSuccessMessage('M3U 文件已成功导入');
                    });
                }
            });
            
            // 导入 TXT 文件
            importTxtBtn.addEventListener('click', function() {
                fileInputTxt.click();
            });
            
            fileInputTxt.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    readFile(file, function(content) {
                        txtInput.value = content;
                        updateCopyButtons();
                        showSuccessMessage('TXT 文件已成功导入');
                    });
                }
            });
            
            // 导出 M3U 文件
            exportM3uBtn.addEventListener('click', function() {
                const content = m3uInput.value.trim();
                if (!content) {
                    alert('M3U 内容为空，无法导出');
                    return;
                }
                
                // 检查内容是否以 #EXTM3U 开头，如果不是，添加文件头
                let exportContent = content;
                if (!exportContent.startsWith('#EXTM3U')) {
                    exportContent = '#EXTM3U\n' + exportContent;
                }
                
                downloadFile(exportContent, 'playlist.m3u', 'text/plain');
                showSuccessMessage('M3U 文件已成功导出');
            });
            
            // 导出 TXT 文件
            exportTxtBtn.addEventListener('click', function() {
                const content = txtInput.value.trim();
                if (!content) {
                    alert('TXT 内容为空，无法导出');
                    return;
                }
                
                downloadFile(content, 'playlist.txt', 'text/plain');
                showSuccessMessage('TXT 文件已成功导出');
            });
            
            // 更新复制按钮显示状态
            function updateCopyButtons() {
                if (m3uInput.value.trim()) {
                    copyM3uBtn.classList.add('show');
                } else {
                    copyM3uBtn.classList.remove('show');
                }
                
                if (txtInput.value.trim()) {
                    copyTxtBtn.classList.add('show');
                } else {
                    copyTxtBtn.classList.remove('show');
                }
            }
            
            // 显示成功提示消息
            function showSuccessMessage(message) {
                // 创建一个临时提示元素
                const successMsg = document.createElement('div');
                successMsg.textContent = message;
                successMsg.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background-color: #2ecc71;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 6px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    z-index: 1000;
                    font-weight: bold;
                    animation: fadeInOut 3s forwards;
                `;
                
                // 添加动画样式
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes fadeInOut {
                        0% { opacity: 0; transform: translateY(-20px); }
                        10% { opacity: 1; transform: translateY(0); }
                        90% { opacity: 1; transform: translateY(0); }
                        100% { opacity: 0; transform: translateY(-20px); }
                    }
                `;
                document.head.appendChild(style);
                
                document.body.appendChild(successMsg);
                
                // 3秒后移除提示
                setTimeout(() => {
                    document.body.removeChild(successMsg);
                    document.head.removeChild(style);
                }, 3000);
            }
            
            // M3U 转 TXT 的转换函数
            function convertM3uToTxt(m3uContent) {
                const lines = m3uContent.split('\n');
                let result = '';
                let currentGroup = '';
                
                // 移除空行
                const nonEmptyLines = lines.filter(line => line.trim() !== '');
                
                // 遍历每一行
                for (let i = 0; i < nonEmptyLines.length; i++) {
                    const line = nonEmptyLines[i].trim();
                    
                    // 跳过 M3U 文件头
                    if (line === '#EXTM3U') {
                        continue;
                    }
                    
                    // 如果是频道信息行
                    if (line.startsWith('#EXTINF:')) {
                        // 解析组名和频道名称
                        let groupMatch = line.match(/group-title="([^"]+)"/);
                        let channelMatch = line.match(/group-title="[^"]+",(.+)$/);
                        
                        if (!channelMatch) {
                            // 尝试另一种可能的格式
                            channelMatch = line.match(/,(.+)$/);
                        }
                        
                        if (groupMatch && channelMatch) {
                            const group = groupMatch[1].trim();
                            const channelName = channelMatch[1].trim();
                            
                            // 如果组名变化，添加新的分组标题
                            if (group !== currentGroup) {
                                if (result !== '') result += '\n';
                                result += `${group},#genre#\n`;
                                currentGroup = group;
                            }
                            
                            // 获取下一行的URL
                            if (i + 1 < nonEmptyLines.length) {
                                const url = nonEmptyLines[i + 1].trim();
                                result += `${channelName},${url}\n`;
                                i++; // 跳过URL行
                            }
                        }
                    }
                }
                
                return result.trim();
            }
            
            // TXT 转 M3U 的转换函数（已修复分组问题）
            function convertTxtToM3u(txtContent) {
                const lines = txtContent.split('\n');
                let result = '#EXTM3U\n';
                let currentGroup = '';
                
                // 遍历每一行
                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (trimmedLine === '') continue;
                    
                    // 检查是否是分组标题行（包含#genre#的行）
                    if (trimmedLine.includes(',#genre#')) {
                        // 提取分组名称（移除#genre#部分）
                        currentGroup = trimmedLine.replace(',#genre#', '').trim();
                        continue;
                    }
                    
                    // 处理频道行
                    const parts = trimmedLine.split(',');
                    if (parts.length >= 2) {
                        const channelName = parts[0].trim();
                        const url = parts.slice(1).join(',').trim(); // URL可能包含逗号，所以重新组合
                        
                        // 如果当前有分组，则使用该分组；否则，只输出频道，不添加group-title
                        if (currentGroup && currentGroup !== '') {
                            result += `#EXTINF:-1 group-title="${currentGroup}",${channelName}\n`;
                        } else {
                            // 如果没有分组信息，只输出频道信息，不添加group-title
                            result += `#EXTINF:-1,${channelName}\n`;
                        }
                        result += `${url}\n`;
                    }
                }
                
                return result.trim();
            }
            
            // 复制到剪贴板
            function copyToClipboard(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
            }
            
            // 读取文件内容
            function readFile(file, callback) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    callback(e.target.result);
                };
                reader.readAsText(file);
            }
            
            // 下载文件
            function downloadFile(content, fileName, contentType) {
                const a = document.createElement('a');
                const file = new Blob([content], {type: contentType});
                a.href = URL.createObjectURL(file);
                a.download = fileName;
                a.click();
                URL.revokeObjectURL(a.href);
            }
        });
    </script>
</body>
</html>
