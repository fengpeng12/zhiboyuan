<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>直播源导入工具</title>
    <style>
        *{-webkit-tap-highlight-color:transparent;box-sizing:border-box}
        body{margin:0;padding:15px;font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f5f5f7;color:#333;line-height:1.5}
        .container{max-width:100%;margin:0 auto}
        .header{text-align:center;margin-bottom:25px;padding:15px 0}
        h1{font-size:24px;font-weight:600;margin:0 0 8px 0;color:#007bff}
        .description{font-size:14px;color:#666;margin:0}
        .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:20px}
        .stat-card{background:white;border-radius:12px;padding:15px;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,0.08)}
        .stat-value{display:block;font-size:24px;font-weight:700;color:#007bff;margin-bottom:5px}
        .stat-label{font-size:13px;color:#666}
        .buttons{display:flex;gap:10px;margin-bottom:20px}
        .btn{flex:1;padding:14px;border:none;border-radius:12px;font-size:16px;font-weight:600;text-align:center;cursor:pointer;transition:transform 0.2s}
        .btn:active{transform:scale(0.98)}
        .btn.blue{background:#007bff;color:white}
        .btn.purple{background:#6f42c1;color:white}
        .btn.green{background:#28a745;color:white}
        .btn.gray{background:#6c757d;color:white}
        .btn.orange{background:#fd7e14;color:white}
        .btn.red{background:#dc3545;color:white}
        .btn.yellow{background:#ffc107;color:#333}
        .results-section{background:white;border-radius:12px;padding:15px;margin-top:15px;box-shadow:0 4px 12px rgba(0,0,0,0.08)}
        .results-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:10px}
        .results-title{font-size:18px;font-weight:600;color:#333}
        .results-filter-buttons{display:flex;gap:8px;margin-bottom:15px;flex-wrap:wrap}
        .filter-btn{padding:8px 16px;border:1px solid #ddd;border-radius:8px;background:white;color:#333;font-size:14px;cursor:pointer;transition:all 0.2s}
        .filter-btn:hover{border-color:#007bff;color:#007bff}
        .filter-btn.active{background:#007bff;color:white;border-color:#007bff}
        .results-list{max-height:400px;overflow-y:auto;border:1px solid #eee;border-radius:8px;margin-bottom:15px}
        .result-item{padding:12px;border-bottom:1px solid #f0f0f0;display:flex;align-items:flex-start;gap:12px}
        .result-item:last-child{border-bottom:none}
        .channel-checkbox{flex-shrink:0;margin-top:2px}
        .channel-info{flex:1;min-width:0}
        .channel-name{font-weight:700;font-size:16px;color:#333;margin-bottom:5px;display:flex;align-items:center;gap:5px;flex-wrap:wrap}
        .channel-url{font-size:11px;color:#666;word-break:break-all;margin-bottom:8px;line-height:1.4}
        .channel-group{display:inline-block;padding:3px 8px;background:#e9f5ff;color:#007bff;border-radius:12px;font-size:12px;margin-right:5px}
        .channel-status{display:inline-block;padding:3px 8px;border-radius:12px;font-size:12px}
        .status-valid{background:#d4edda;color:#155724}
        .status-invalid{background:#f8d7da;color:#721c24}
        .status-checking{background:#fff3cd;color:#856404}
        .empty-list{text-align:center;padding:30px 20px;color:#999}
        .pagination-controls{display:flex;justify-content:space-between;align-items:center;margin-top:15px;padding:10px 0;border-top:1px solid #eee;flex-wrap:wrap;gap:10px}
        .page-size-control{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
        .page-size-label{font-size:14px;color:#666;white-space:nowrap}
        .page-size-input{width:70px;padding:8px 10px;border:1px solid #ddd;border-radius:6px;font-size:14px;text-align:center}
        .page-size-input:focus{outline:none;border-color:#007bff}
        .pagination-info{font-size:14px;color:#666;text-align:center;flex-grow:1}
        .pagination-buttons{display:flex;gap:8px;align-items:center}
        .page-btn{padding:8px 14px;border:1px solid #ddd;border-radius:6px;background:white;color:#333;font-size:14px;cursor:pointer;transition:all 0.2s;min-width:40px;text-align:center}
        .page-btn:active{transform:scale(0.95)}
        .page-btn:hover{border-color:#007bff;color:#007bff}
        .page-btn.active{background:#007bff;color:white;border-color:#007bff}
        .page-btn:disabled{opacity:0.5;cursor:not-allowed;border-color:#ddd;color:#999}
        .check-actions{display:flex;justify-content:space-between;align-items:center;margin-top:15px;padding:10px 0;border-top:1px solid #eee;flex-wrap:wrap;gap:10px}
        .checkbox-controls{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
        .export-actions{display:flex;gap:8px;flex-wrap:wrap}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000}
        .modal-content{position:absolute;bottom:0;left:0;width:100%;background:white;border-radius:20px 20px 0 0;animation:slideUp 0.3s ease;max-height:80vh;overflow-y:auto}
        @keyframes slideUp{from{transform:translateY(100%)} to{transform:translateY(0)}}
        .modal-header{padding:20px;border-bottom:1px solid #eee;text-align:center}
        .modal-title{font-size:18px;font-weight:600;color:#333;margin:0}
        .modal-body{padding:20px}
        .modal-footer{padding:20px;display:flex;gap:10px;border-top:1px solid #eee}
        .url-input{width:100%;padding:14px;border:1px solid #ddd;border-radius:8px;font-size:16px;margin-bottom:15px}
        .url-input:focus{outline:none;border-color:#007bff}
        .status{padding:10px;border-radius:8px;margin-bottom:15px;display:none;font-size:14px}
        .status.success{background:#d4edda;color:#155724}
        .status.error{background:#f8d7da;color:#721c24}
        .examples{font-size:13px;color:#666;margin-top:15px}
        .example-url{background:#f8f9fa;border-radius:6px;padding:8px;margin:5px 0;font-family:monospace;font-size:12px;word-break:break-all}
        .group-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:12px;margin-bottom:20px}
        .group-item{padding:15px;border:1px solid #ddd;border-radius:12px;cursor:pointer;text-align:center;transition:all 0.2s}
        .group-item.selected{background:#e9f5ff;border-color:#007bff}
        .group-name{font-weight:600;color:#007bff;margin-bottom:5px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .group-count{font-size:12px;color:#666}
        .loading{text-align:center;padding:20px;display:none}
        .loading-spinner{width:40px;height:40px;border:3px solid #f3f3f3;border-top:3px solid #007bff;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 10px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .formats{font-size:14px;color:#666;margin-top:15px}
        .format-code{background:#f8f9fa;border-radius:6px;padding:8px;margin:5px 0;font-family:monospace;font-size:13px}
        .file-input-label{display:block;padding:20px;background:#f8f9fa;border:2px dashed #ddd;border-radius:12px;text-align:center;color:#666;cursor:pointer;margin-bottom:10px}
        input[type="file"]{display:none}
        /* 新增检测相关样式 */
        .check-controls{display:flex;flex-direction:column;gap:10px;margin-bottom:20px}
        .check-buttons{display:flex;gap:10px}
        .check-configs{display:flex;flex-direction:column;gap:12px;background:white;padding:15px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
        .config-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
        .config-label{font-size:14px;color:#666;white-space:nowrap}
        .config-slider{flex:1;height:6px;-webkit-appearance:none;appearance:none;background:#e9ecef;border-radius:3px;outline:none;min-width:100px}
        .config-slider::-webkit-slider-thumb{width:18px;height:18px;-webkit-appearance:none;appearance:none;background:#007bff;border-radius:50%;cursor:pointer}
        .config-value{font-size:14px;font-weight:600;color:#007bff;min-width:40px}
        .check-progress{background:white;border-radius:12px;padding:15px;margin-bottom:15px;box-shadow:0 2px 8px rgba(0,0,0,0.08);display:none}
        .progress-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
        .progress-title{font-size:16px;font-weight:600;color:#333}
        .progress-stats{font-size:14px;color:#666}
        .progress-bar{width:100%;height:8px;background:#e9ecef;border-radius:4px;overflow:hidden}
        .progress-fill{height:100%;background:#007bff;border-radius:4px;transition:width 0.3s ease;width:0%}
        .progress-details{margin-top:10px;font-size:13px;color:#666}
        /* 播放按钮样式 */
        .play-btn{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;background:#28a745;color:white;border:none;border-radius:50%;font-size:12px;cursor:pointer;padding:0;margin-left:5px;transition:transform 0.2s}
        .play-btn:hover{transform:scale(1.1);background:#218838}
        .play-btn:active{transform:scale(0.95)}
        /* 内嵌视频播放器样式 - 增大视频显示 */
        .video-preview-container{background:white;border-radius:12px;padding:20px;margin-top:15px;box-shadow:0 4px 12px rgba(0,0,0,0.08);display:block; /* 改为block，默认显示 */}
        .video-preview-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .video-preview-title{font-size:20px;font-weight:600;color:#333;margin:0}
        .video-preview-close{background:#6c757d;border:none;color:white;font-size:20px;cursor:pointer;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:50%}
        .video-preview-body{position:relative;background:#000;border-radius:8px;overflow:hidden;width:100%;height:500px;display:flex;justify-content:center;align-items:center}
        #videoPlayer{width:100%;height:100%;max-width:100%;max-height:100%;object-fit:contain;display:none} /* 初始隐藏 */
        .video-loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:white;font-size:18px;display:none}
        .video-info{padding:20px 0 0;border-top:1px solid #eee;margin-top:20px}
        .video-info-url{font-size:14px;color:#666;word-break:break-all;margin:0}
        .video-controls{display:flex;justify-content:space-between;align-items:center;margin-top:15px;flex-wrap:wrap;gap:10px}
        .video-channel-info{font-size:16px;color:#333;font-weight:500;margin-bottom:5px}
        .video-control-buttons{display:flex;gap:10px}
        .video-control-btn{padding:8px 16px;border:1px solid #ddd;border-radius:8px;background:white;color:#333;font-size:14px;cursor:pointer;font-weight:500}
        .video-control-btn:hover{border-color:#007bff;color:#007bff}
        .video-control-btn.red{background:#dc3545;color:white;border-color:#dc3545}
        .video-control-btn.red:hover{background:#c82333;border-color:#bd2130}
        .video-status{font-size:13px;color:#666;margin-top:5px}
        /* 新增：视频预览初始状态占位符 */
        .video-placeholder{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#999;font-size:16px;text-align:center;display:block}
        /* 新增：有效结果勾选控制区域样式 */
        .valid-selection-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding:10px;background:#f8f9fa;border-radius:8px;flex-wrap:wrap;gap:10px}
        .valid-selection-info{font-size:14px;color:#333}
        .valid-selection-buttons{display:flex;gap:8px}
        .valid-selection-btn{padding:6px 12px;border:1px solid #ddd;border-radius:6px;background:white;color:#333;font-size:13px;cursor:pointer;font-weight:500}
        .valid-selection-btn:hover{border-color:#007bff;color:#007bff}
        .valid-selection-btn.yellow{background:#ffc107;color:#333;border-color:#ffc107}
        .valid-selection-btn.yellow:hover{background:#e0a800;border-color:#d39e00}
        /* 勾选框样式 */
        .result-checkbox{width:18px;height:18px;cursor:pointer}
        @media (max-width:1024px){
            .video-preview-body{height:450px}
        }
        @media (max-width:768px){
            .video-preview-body{height:400px}
            .video-preview-title{font-size:18px}
            .video-channel-info{font-size:14px}
            .valid-selection-controls{flex-direction:column;align-items:stretch}
            .valid-selection-buttons{justify-content:center}
        }
        @media (max-width:480px){
            .pagination-controls{flex-direction:column;align-items:stretch}
            .page-size-control{justify-content:center}
            .pagination-buttons{justify-content:center}
            .check-buttons{flex-direction:column}
            .config-row{flex-direction:column;align-items:stretch;gap:10px}
            .video-preview-body{height:350px}
            .video-controls{flex-direction:column;align-items:flex-start}
            .video-preview-title{font-size:16px}
            .video-channel-info{font-size:14px}
            .results-filter-buttons{flex-wrap:wrap}
            .filter-btn{flex:1;min-width:100px}
            .check-actions{flex-direction:column;align-items:stretch}
            .checkbox-controls{justify-content:center}
            .export-actions{justify-content:center}
            .valid-selection-buttons{flex-direction:column}
            .valid-selection-btn{width:100%;text-align:center}
        }
        @media (min-width:1400px){
            .video-preview-body{height:550px}
        }
        @media (min-width:1600px){
            .video-preview-body{height:600px}
        }
        @media (orientation: landscape) and (max-width: 900px){
            .video-preview-body{height:300px}
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>直播源导入工具</h1>
            <p class="description">快速导入和管理直播源</p>
        </header>
        
        <div class="stats">
            <div class="stat-card"><span class="stat-value" id="totalCount">0</span><span class="stat-label">总直播源</span></div>
            <div class="stat-card"><span class="stat-value" id="groupCount">0</span><span class="stat-label">分组数量</span></div>
            <div class="stat-card"><span class="stat-value" id="uniqueCount">0</span><span class="stat-label">唯一源数</span></div>
            <div class="stat-card"><span class="stat-value" id="duplicateCount">0</span><span class="stat-label">重复源数</span></div>
        </div>
        
        <!-- 新增检测控制区域 -->
        <div class="check-controls">
            <div class="check-buttons">
                <button class="btn orange" id="checkPageBtn">检测当前页</button>
                <button class="btn orange" id="checkAllBtn">检测全部页</button>
                <button class="btn orange" id="checkGroupBtn">分组检测</button>
                <button class="btn red" id="stopCheckBtn" style="display:none">停止检测</button>
            </div>
            
            <!-- 检测配置区域 -->
            <div class="check-configs">
                <div class="config-row">
                    <span class="config-label">检测超时:</span>
                    <input type="range" id="timeoutSlider" class="config-slider" min="3" max="20" value="8">
                    <span id="timeoutValue" class="config-value">8秒</span>
                </div>
                <div class="config-row">
                    <span class="config-label">并发数量:</span>
                    <input type="range" id="concurrencySlider" class="config-slider" min="1" max="30" value="5">
                    <span id="concurrencyValue" class="config-value">5个</span>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <span id="checkStatusText" style="font-size:13px;color:#666">就绪</span>
                    <span id="concurrentStatus" style="font-size:12px;color:#007bff;background:#e9f5ff;padding:2px 8px;border-radius:10px">并发:5个</span>
                </div>
            </div>
        </div>
        
        <!-- 新增检测进度显示 -->
        <div class="check-progress" id="checkProgress">
            <div class="progress-header">
                <div class="progress-title">检测进度</div>
                <div class="progress-stats">
                    <span id="checkProgressText">准备中...</span>
                    <span id="checkCancelBtn" style="margin-left:10px;color:#dc3545;cursor:pointer;font-size:12px">[取消]</span>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-details">
                <span id="checkDetails">等待开始检测...</span>
            </div>
        </div>
        
        <div class="buttons">
            <button class="btn blue" id="localImportBtn">本地导入</button>
            <button class="btn purple" id="networkImportBtn">网络导入</button>
            <button class="btn green" id="groupBtn">分组管理</button>
        </div>
        
        <!-- 内嵌视频播放器 - 移到结果区域上方并保持显示，增大视频显示 -->
        <div class="video-preview-container" id="videoPreview">
            <div class="video-preview-header">
                <h3 class="video-preview-title">视频预览</h3>
                <button class="video-preview-close" id="closeVideoBtn">×</button>
            </div>
            <div class="video-preview-body">
                <div class="video-placeholder" id="videoPlaceholder">视频预览区域，点击播放按钮开始预览</div>
                <video id="videoPlayer" controls preload="metadata" playsinline>
                    <source id="videoSource" src="" type="application/x-mpegURL">
                    您的浏览器不支持视频播放
                </video>
                <div class="video-loading" id="videoLoading">加载中...</div>
            </div>
            <div class="video-info">
                <p class="video-channel-info" id="videoTitle">未选择频道</p>
                <p class="video-info-url" id="videoUrl">URL: 无</p>
                <div class="video-controls">
                    <div class="video-status" id="videoStatus">就绪</div>
                    <div class="video-control-buttons">
                        <button class="video-control-btn" id="reloadVideoBtn">重新加载</button>
                        <button class="video-control-btn red" id="stopVideoBtn">停止播放</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="results-section">
            <div class="results-header">
                <h3 class="results-title">导入结果</h3>
                <div>
                    <button class="btn gray" id="clearBtn" style="padding:8px 12px;font-size:14px">清空</button>
                </div>
            </div>
            
            <!-- 新增筛选按钮 -->
            <div class="results-filter-buttons">
                <button class="filter-btn active" id="filterAllBtn">全部结果</button>
                <button class="filter-btn" id="filterValidBtn">有效结果</button>
                <button class="filter-btn" id="filterInvalidBtn">无效结果</button>
            </div>
            
            <!-- 新增有效结果勾选控制区域 -->
            <div class="valid-selection-controls" id="validSelectionControls" style="display:none">
                <div class="valid-selection-info">
                    已选择 <span id="selectedValidCount">0</span> 个有效源 / 共 <span id="totalValidCount">0</span> 个有效源
                </div>
                <div class="valid-selection-buttons">
                    <button class="valid-selection-btn" id="selectAllValidBtn">全部勾选</button>
                    <button class="valid-selection-btn" id="deselectAllValidBtn">全部取消</button>
                    <button class="valid-selection-btn yellow" id="exportValidSelectedBtn">导出勾选的有效源</button>
                </div>
            </div>
            
            <div class="results-list" id="resultsList">
                <div class="empty-list">暂无数据，请导入直播源</div>
            </div>
            
            <!-- 新增勾选控制区域 -->
            <div class="check-actions" id="checkActions" style="display:none">
                <div class="checkbox-controls">
                    <input type="checkbox" id="selectAllCheckbox" checked>
                    <label for="selectAllCheckbox" style="font-size:14px;color:#333;cursor:pointer">全选当前页</label>
                    <span style="font-size:13px;color:#666;margin-left:10px">
                        已选择 <span id="selectedCount">0</span> / <span id="totalCheckCount">0</span> 个
                    </span>
                </div>
                <div class="export-actions">
                    <button class="btn yellow" id="exportSelectedBtn" style="padding:8px 12px;font-size:14px">导出勾选源</button>
                </div>
            </div>
            
            <div class="pagination-controls" id="paginationControls" style="display:none">
                <div class="page-size-control">
                    <span class="page-size-label">每页显示:</span>
                    <input type="number" id="pageSizeInput" class="page-size-input" min="5" max="100" value="10">
                    <span class="page-size-label">条</span>
                </div>
                <div class="pagination-info" id="paginationInfo">
                    第 <span id="currentPage">1</span> 页 / 共 <span id="totalPages">1</span> 页
                </div>
                <div class="pagination-buttons">
                    <button class="page-btn" id="firstPageBtn" title="首页">«</button>
                    <button class="page-btn" id="prevPageBtn" title="上一页">‹</button>
                    <div id="pageNumbers" style="display:flex;gap:4px"></div>
                    <button class="page-btn" id="nextPageBtn" title="下一页">›</button>
                    <button class="page-btn" id="lastPageBtn" title="末页">»</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 网络导入模态框 -->
    <div class="modal" id="networkModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">网络导入</h3>
            </div>
            <div class="modal-body">
                <input type="text" id="networkUrl" class="url-input" placeholder="输入直播源URL地址">
                <div id="networkStatus" class="status"></div>
                <div class="examples">
                    <p><strong>示例：</strong></p>
                    <div class="example-url">http://example.com/channels.txt</div>
                    <div class="example-url">https://raw.githubusercontent.com/user/repo/channels.m3u</div>
                    <p>支持.txt/.m3u/.m3u8格式</p>
                </div>
                <div class="formats">
                    <p><strong>支持格式：</strong></p>
                    <div class="format-code">频道名称,URL地址</div>
                    <div class="format-code">分组名称,#genre#分组名称</div>
                </div>
                <div class="loading" id="networkLoading">
                    <div class="loading-spinner"></div>
                    <p>正在下载并解析...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn gray" id="cancelImportBtn">取消</button>
                <button class="btn blue" id="confirmImportBtn">导入</button>
            </div>
        </div>
    </div>
    
    <!-- 分组管理模态框 -->
    <div class="modal" id="groupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">分组管理</h3>
            </div>
            <div class="modal-body">
                <p style="margin-bottom:15px">选择分组（可多选）：</p>
                <div class="group-grid" id="groupCheckboxes"></div>
                <div style="display:flex;gap:10px;margin-top:20px">
                    <button class="btn blue" id="selectAllGroupsBtn">全选</button>
                    <button class="btn gray" id="deselectAllGroupsBtn">取消全选</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn gray" id="closeGroupBtn">关闭</button>
            </div>
        </div>
    </div>
    
    <input type="file" id="fileInput" accept=".txt,.m3u,.m3u8">

<script>
(function(){
const state={
    data:[],
    groups:new Set(),
    importData:{groupInfo:{},sources:{}},
    selectedGroups:[],
    duplicates:0,
    pagination:{currentPage:1,pageSize:10,totalPages:1},
    // 新增状态
    checkStatus:{}, // 存储检测状态
    checking:false, // 是否正在检测
    currentCheckMode:'', // 当前检测模式: 'currentPage', 'allPages' 或 'group'
    checkTimeout:8, // 默认检测超时时间(秒)
    concurrency:5, // 默认并发数量
    allPagesCheckQueue:[], // 全页检测队列
    currentPageCheckIndex:0, // 当前页检测索引
    // 视频播放状态
    currentPlayingUrl:'', // 当前播放的URL
    currentPlayingName:'', // 当前播放的频道名称
    isVideoPlaying:false, // 视频是否正在播放
    // 新增：有效结果勾选状态
    selectedValidUrls:new Set() // 存储勾选的有效频道URL
};

const e=id=>document.getElementById(id);
const els={
    totalCount:e('totalCount'),groupCount:e('groupCount'),uniqueCount:e('uniqueCount'),duplicateCount:e('duplicateCount'),
    localImportBtn:e('localImportBtn'),networkImportBtn:e('networkImportBtn'),groupBtn:e('groupBtn'),clearBtn:e('clearBtn'),
    resultsList:e('resultsList'),networkModal:e('networkModal'),networkUrl:e('networkUrl'),networkStatus:e('networkStatus'),networkLoading:e('networkLoading'),
    cancelImportBtn:e('cancelImportBtn'),confirmImportBtn:e('confirmImportBtn'),groupModal:e('groupModal'),groupCheckboxes:e('groupCheckboxes'),
    selectAllGroupsBtn:e('selectAllGroupsBtn'),deselectAllGroupsBtn:e('deselectAllGroupsBtn'),closeGroupBtn:e('closeGroupBtn'),
    fileInput:e('fileInput'),paginationControls:e('paginationControls'),pageSizeInput:e('pageSizeInput'),
    currentPage:e('currentPage'),totalPages:e('totalPages'),paginationInfo:e('paginationInfo'),firstPageBtn:e('firstPageBtn'),prevPageBtn:e('prevPageBtn'),
    pageNumbers:e('pageNumbers'),nextPageBtn:e('nextPageBtn'),lastPageBtn:e('lastPageBtn'),
    // 新增元素
    checkPageBtn:e('checkPageBtn'),checkAllBtn:e('checkAllBtn'),checkGroupBtn:e('checkGroupBtn'),stopCheckBtn:e('stopCheckBtn'),
    timeoutSlider:e('timeoutSlider'),timeoutValue:e('timeoutValue'),concurrencySlider:e('concurrencySlider'),concurrencyValue:e('concurrencyValue'),
    checkProgress:e('checkProgress'),progressFill:e('progressFill'),checkProgressText:e('checkProgressText'),
    checkDetails:e('checkDetails'),checkCancelBtn:e('checkCancelBtn'),checkStatusText:e('checkStatusText'),
    concurrentStatus:e('concurrentStatus'),
    // 内嵌视频播放器元素
    videoPreview:e('videoPreview'),videoPlayer:e('videoPlayer'),videoSource:e('videoSource'),
    videoTitle:e('videoTitle'),videoUrl:e('videoUrl'),closeVideoBtn:e('closeVideoBtn'),
    videoLoading:e('videoLoading'),reloadVideoBtn:e('reloadVideoBtn'),stopVideoBtn:e('stopVideoBtn'),
    videoStatus:e('videoStatus'),videoPlaceholder:e('videoPlaceholder'),
    // 新增筛选元素
    filterAllBtn:e('filterAllBtn'),filterValidBtn:e('filterValidBtn'),filterInvalidBtn:e('filterInvalidBtn'),
    selectAllCheckbox:e('selectAllCheckbox'),exportSelectedBtn:e('exportSelectedBtn'),
    selectedCount:e('selectedCount'),totalCheckCount:e('totalCheckCount'),checkActions:e('checkActions'),
    // 新增有效结果勾选元素
    validSelectionControls:e('validSelectionControls'),
    selectedValidCount:e('selectedValidCount'),totalValidCount:e('totalValidCount'),
    selectAllValidBtn:e('selectAllValidBtn'),deselectAllValidBtn:e('deselectAllValidBtn'),
    exportValidSelectedBtn:e('exportValidSelectedBtn')
};

const utils={
    fixUrl:u=>u.replace(/\\\//g,'/'),
    normalizeUrl:u=>{try{let f=utils.fixUrl(u);if(!f.startsWith('http://')&&!f.startsWith('https://'))f='http://'+f;
    const o=new URL(f);let n=`${o.protocol}//${o.hostname}`;if(o.port&&o.port!=='80'&&o.port!=='443')n+=`:${o.port}`;
    n+=o.pathname.replace(/\/+$/,'');if(o.search)n+=o.search;return n}catch{return utils.fixUrl(u)}},
    showStatus:(m,isErr)=>{const s=els.networkStatus;if(!s)return;s.textContent=m;s.className=`status ${isErr?'error':'success'}`;s.style.display='block';
    if(!isErr)setTimeout(()=>s.style.display='none',3000)},
    showLoading:s=>{if(els.networkLoading)els.networkLoading.style.display=s?'block':'none'},
    hideModal:m=>{const e=document.getElementById(m);if(e)e.style.display='none'},
    updateStats:()=>{els.totalCount.textContent=state.data.length;els.groupCount.textContent=state.groups.size;
    const u=new Set(),d=new Map();state.data.forEach(i=>{const n=utils.normalizeUrl(i.url);d.has(n)?d.set(n,d.get(n)+1):(d.set(n,1),u.add(n))});
    let dc=0;d.forEach(c=>{if(c>1)dc+=c-1});state.duplicates=dc;els.uniqueCount.textContent=u.size;els.duplicateCount.textContent=dc},
    calculatePagination:()=>{const t=state.data.length,ps=parseInt(state.pagination.pageSize)||10,tp=Math.max(1,Math.ceil(t/ps));
    let cp=Math.min(Math.max(1,state.pagination.currentPage),tp);state.pagination={currentPage:cp,pageSize:ps,totalPages:tp};
    return{currentPage:cp,pageSize:ps,totalPages:tp,startIndex:(cp-1)*ps,endIndex:Math.min(cp*ps,t)}},
    updatePaginationControls:()=>{const p=utils.calculatePagination();els.currentPage.textContent=p.currentPage;
    els.totalPages.textContent=p.totalPages;els.pageSizeInput.value=p.pageSize;els.paginationControls.style.display=state.data.length>0?'flex':'none';
    els.firstPageBtn.disabled=p.currentPage<=1;els.prevPageBtn.disabled=p.currentPage<=1;els.nextPageBtn.disabled=p.currentPage>=p.totalPages;
    els.lastPageBtn.disabled=p.currentPage>=p.totalPages;utils.generatePageNumbers(p)},
    generatePageNumbers:p=>{els.pageNumbers.innerHTML='';const s=Math.max(1,p.currentPage-3),e=Math.min(p.totalPages,s+6);
    for(let i=s;i<=e;i++){const b=document.createElement('button');b.className=`page-btn ${i===p.currentPage?'active':''}`;
    b.textContent=i;b.setAttribute('data-page',i);b.title=`第${i}页`;els.pageNumbers.appendChild(b)}},
    // 根据筛选条件获取数据
    getFilteredData:()=>{
        if(state.currentFilter==='all')return state.data;
        if(state.currentFilter==='valid'){
            return state.data.filter(item=>{
                const status=state.checkStatus[item.url];
                return status&&status.status==='checked'&&status.valid===true;
            });
        }
        if(state.currentFilter==='invalid'){
            return state.data.filter(item=>{
                const status=state.checkStatus[item.url];
                return !status||status.status!=='checked'||status.valid===false;
            });
        }
        return state.data;
    },
    getCurrentPageData:()=>{
        const p=utils.calculatePagination();
        const d=state.data.slice(p.startIndex,p.endIndex);
        return d;
    },
    // 获取所有有效结果
    getAllValidData:()=>{
        return state.data.filter(item=>{
            const status=state.checkStatus[item.url];
            return status&&status.status==='checked'&&status.valid===true;
        });
    },
    // 获取当前筛选条件下的数据
    getCurrentFilterData:()=>{
        const filteredData=utils.getFilteredData();
        const p=utils.calculatePagination();
        // 重新计算筛选后的分页
        const totalFiltered=filteredData.length;
        const pageSize=parseInt(state.pagination.pageSize)||10;
        const totalPages=Math.max(1,Math.ceil(totalFiltered/pageSize));
        let currentPage=Math.min(Math.max(1,state.pagination.currentPage),totalPages);
        const startIndex=(currentPage-1)*pageSize;
        const endIndex=Math.min(currentPage*pageSize,totalFiltered);
        
        // 更新分页状态
        state.pagination.totalPages=totalPages;
        if(currentPage>totalPages&&totalPages>0){
            currentPage=totalPages;
            state.pagination.currentPage=currentPage;
        }
        
        return filteredData.slice(startIndex,endIndex);
    },
    updateResultsList:()=>{
        const filteredData=utils.getFilteredData();
        
        if(!filteredData.length){
            els.resultsList.innerHTML='<div class="empty-list">暂无数据，请导入直播源</div>';
            els.paginationControls.style.display='none';
            els.checkActions.style.display='none';
            els.validSelectionControls.style.display='none';
            return;
        }
        
        const d=utils.getCurrentFilterData();
        const p=utils.calculatePagination();
        const filteredTotal=filteredData.length;
        
        let h='';d.forEach((i,idx)=>{
            const f=utils.fixUrl(i.url),n=utils.normalizeUrl(i.url);
            let dup=false;
            const a=state.data.map(d=>utils.normalizeUrl(d.url)),ii=state.data.indexOf(i),fi=a.indexOf(n);
            if(fi!==-1&&fi<ii)dup=true;
            const ai=((p.currentPage-1)*p.pageSize)+idx+1;
            // 获取检测状态
            const status=state.checkStatus[i.url]||{status:'unchecked',valid:false};
            let statusClass='',statusText='';
            switch(status.status){
                case 'checking':statusClass='status-checking';statusText='检测中';break;
                case 'checked':statusClass=status.valid?'status-valid':'status-invalid';statusText=status.valid?'有效':'无效';break;
                default:statusClass='';statusText='未检测';
            }
            // 添加播放按钮（只有检测有效时才显示）
            const playButton = status.status === 'checked' && status.valid ? 
                `<button class="play-btn" data-url="${i.url}" data-name="${i.name}" title="播放验证">▶</button>` : '';
            
            // 只有在有效结果筛选模式下才显示勾选框
            const showCheckbox = state.currentFilter === 'valid';
            const isChecked = state.selectedValidUrls.has(i.url);
            
            h+=`<div class="result-item" style="${dup?'opacity:0.7;background-color:#f8f9fa':''}">
                ${showCheckbox?`<div class="channel-checkbox"><input type="checkbox" class="result-checkbox" data-url="${i.url}" ${isChecked?'checked':''}></div>`:''}
                <div class="channel-info">
                    <div class="channel-name">${ai}. ${i.name}${dup?'<span style="color:#dc3545;font-size:12px;margin-left:8px">[重复]</span>':''}
                        ${statusText?`<span class="channel-status ${statusClass}">${statusText}</span>`:''}
                        ${playButton}
                    </div>
                    <div class="channel-url">${f}</div>
                    <div class="channel-group">${i.group}</div>
                </div>
            </div>`;
        });
        els.resultsList.innerHTML=h;
        
        // 更新分页信息
        const totalFiltered=filteredData.length;
        const totalPages=Math.max(1,Math.ceil(totalFiltered/p.pageSize));
        els.currentPage.textContent=p.currentPage;
        els.totalPages.textContent=totalPages;
        els.pageSizeInput.value=p.pageSize;
        els.paginationControls.style.display=totalFiltered>0?'flex':'none';
        els.checkActions.style.display=totalFiltered>0?'flex':'none';
        
        // 只在有效结果模式下显示勾选控制区域
        if(state.currentFilter === 'valid'){
            els.validSelectionControls.style.display='flex';
            // 更新有效结果统计
            const validData = utils.getAllValidData();
            els.selectedValidCount.textContent = state.selectedValidUrls.size;
            els.totalValidCount.textContent = validData.length;
        } else {
            els.validSelectionControls.style.display='none';
        }
        
        utils.updatePaginationControls();
        setTimeout(()=>els.resultsList.scrollTop=0,100);
    },
    updateGroupList:()=>{els.groupCheckboxes.innerHTML='';if(!state.groups.size){els.groupCheckboxes.innerHTML='<div style="grid-column:1/-1;text-align:center;color:#999;padding:20px">暂无分组</div>';return}
    const g={};state.data.forEach(i=>g[i.group]=(g[i.group]||0)+1);state.groups.forEach(gp=>{const c=g[gp]||0,s=state.selectedGroups.includes(gp);
    const d=document.createElement('div');d.className=`group-item ${s?'selected':''}`;d.setAttribute('data-group',gp);
    d.innerHTML=`<div class="group-name">${gp}</div><div class="group-count">${c}个源</div><input type="checkbox" class="group-checkbox" ${s?'checked':''} style="display:none">`;els.groupCheckboxes.appendChild(d)})},
    parseSourceText:t=>{const r=[];let cg='默认分组';const l=t.split('\n');state.importData={groupInfo:{},sources:{}};
    l.forEach(line=>{const ol=line;line=line.trim();if(!line)return;if(line.includes(',#genre#')){const m=line.match(/^(.*),#genre#(.*)$/);
    if(m){cg=(m[2]||m[1]).trim();state.importData.groupInfo[cg]=utils.fixUrl(ol)}}});cg='默认分组';
    l.forEach(line=>{const ol=line;line=line.trim();if(!line)return;if(line.includes(',#genre#')){const m=line.match(/^(.*),#genre#(.*)$/);
    if(m){cg=(m[2]||m[1]).trim()}return}if(line.startsWith('#')||line.startsWith('//'))return;
    let ci=line.indexOf(',');let cn=cg;let up=line;if(ci!==-1){cn=line.substring(0,ci).trim();up=line.substring(ci+1).trim()}
    const fu=utils.fixUrl(up);const m=fu.match(/(https?:\/\/[^\s<>"']+)/gi);if(m){m.forEach(u=>{u=u.replace(/[\s,;'"`]+$/,'');u=utils.fixUrl(u);
    if(u.length>10){r.push({name:cn,url:u,group:cg});state.importData.sources[u]={originalLine:utils.fixUrl(ol),group:cg,name:cn}}})}});return r},
    addSources:s=>{const oc=state.data.length,ogs=state.groups.size,eu=new Set();state.data.forEach(i=>eu.add(utils.normalizeUrl(i.url)));
    const nd=new Set(),au=new Set();let ac=0,dc=0;s.forEach(src=>{const n=utils.normalizeUrl(src.url);
    if(eu.has(n)||au.has(n)){dc++;nd.add(src.url);return}au.add(n);eu.add(n);state.data.push(src);state.groups.add(src.group);ac++});
    state.duplicates+=dc;state.pagination.currentPage=1;return{added:ac,newGroups:state.groups.size-ogs,duplicates:dc}},
    removeDuplicates:()=>{if(!state.data.length)return;const u=new Map(),nd=[];state.data.forEach(i=>{const n=utils.normalizeUrl(i.url);
    if(!u.has(n)){u.set(n,i);nd.push(i)}});const rc=state.data.length-nd;if(rc){state.data=nd;state.groups.clear();state.data.forEach(i=>state.groups.add(i.group));
    state.duplicates=0;state.pagination.currentPage=1;alert(`已删除${rc}个重复项`);return true}return false},
    // 新增：检测单个直播源（并发版本）
    async checkSource(url,timeout){
        const startTime=Date.now();
        const controller=new AbortController();
        const timeoutId=setTimeout(()=>controller.abort(),timeout*1000);
        
        try{
            // 第一步：使用fetch检测连接
            const response=await fetch(url,{
                method:'HEAD',
                signal:controller.signal,
                headers:{'User-Agent':'Mozilla/5.0'},
                mode:'no-cors'
            });
            clearTimeout(timeoutId);
            
            // 如果能通过fetch检测，再进行二次验证
            if(response.ok||response.type==='opaque'){
                // 第二步：使用video元素进行canplaythrough验证
                return new Promise((resolve)=>{
                    const video=document.createElement('video');
                    video.preload='metadata';
                    video.muted=true;
                    video.playsInline=true;
                    
                    const playTimeout=setTimeout(()=>{
                        video.remove();
                        resolve({valid:false,reason:'视频加载超时',time:Date.now()-startTime});
                    },(timeout-1)*1000);
                    
                    video.oncanplaythrough=()=>{
                        clearTimeout(playTimeout);
                        video.remove();
                        resolve({valid:true,reason:'视频可播放',time:Date.now()-startTime});
                    };
                    
                    video.onerror=()=>{
                        clearTimeout(playTimeout);
                        video.remove();
                        resolve({valid:false,reason:'视频加载失败',time:Date.now()-startTime});
                    };
                    
                    video.src=url;
                });
            }else{
                return {valid:false,reason:`HTTP状态:${response.status}`,time:Date.now()-startTime};
            }
        }catch(error){
            clearTimeout(timeoutId);
            return {valid:false,reason:error.name==='AbortError'?'请求超时':`错误:${error.message}`,time:Date.now()-startTime};
        }
    },
    // 新增：并发控制函数
    async concurrentCheck(sources, timeout, concurrency, updateProgressCallback) {
        let totalChecked = 0;
        let totalValid = 0;
        const totalSources = sources.length;
        
        // 将源分成多个批次进行并发检测
        for (let i = 0; i < sources.length; i += concurrency) {
            if (!state.checking) break;
            
            const batch = sources.slice(i, i + concurrency);
            const batchPromises = batch.map(async (source) => {
                const url = utils.fixUrl(source.url);
                
                // 更新状态为检测中
                state.checkStatus[source.url] = {status: 'checking', valid: false};
                utils.updateResultsList();
                
                // 执行检测
                const result = await utils.checkSource(url, timeout);
                
                // 更新状态
                state.checkStatus[source.url] = {
                    status: 'checked',
                    valid: result.valid,
                    reason: result.reason,
                    time: result.time
                };
                
                // 如果检测有效，自动勾选
                if(result.valid){
                    state.selectedValidUrls.add(source.url);
                }
                
                return {source, result};
            });
            
            // 等待当前批次的所有检测完成
            const batchResults = await Promise.allSettled(batchPromises);
            
            // 处理批次结果
            for (const result of batchResults) {
                if (result.status === 'fulfilled') {
                    totalChecked++;
                    if (result.value.result.valid) totalValid++;
                    
                    // 更新进度回调
                    if (updateProgressCallback) {
                        updateProgressCallback(totalChecked, totalSources, result.value.source, result.value.result);
                    }
                }
            }
            
            // 批次之间短暂延迟，避免浏览器过载
            if (state.checking && i + concurrency < sources.length) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }
        
        return {totalChecked, totalValid};
    },
    // 新增：检测当前页（并发版本）
    async checkCurrentPage(){
        const pageData=utils.getCurrentPageData();
        if(pageData.length===0){
            alert('当前页没有直播源！');
            return {totalChecked:0,totalValid:0};
        }
        
        // 更新进度显示
        els.progressFill.style.width='0%';
        els.checkProgressText.textContent=`当前页检测`;
        els.checkDetails.textContent=`正在检测当前页，共${pageData.length}个直播源，并发数: ${state.concurrency}个...`;
        
        // 使用并发检测
        const result = await utils.concurrentCheck(pageData, state.checkTimeout, state.concurrency, 
            (checked, total, source, checkResult) => {
                const progressPercent = Math.round(checked / total * 100);
                els.progressFill.style.width = `${progressPercent}%`;
                els.checkDetails.textContent = `当前页: ${checked}/${total} (${progressPercent}%) - ${source.name}: ${checkResult.valid?'有效':'无效'} (${checkResult.time}ms)`;
            }
        );
        
        return result;
    },
    // 新增：检测所有页（并发版本）
    async checkAllPages(){
        const totalPages=state.pagination.totalPages;
        let totalChecked=0,totalValid=0;
        
        // 创建页面队列
        state.allPagesCheckQueue=[];
        for(let page=1;page<=totalPages;page++){
            state.allPagesCheckQueue.push(page);
        }
        
        // 逐个页面检测
        while(state.allPagesCheckQueue.length>0&&state.checking){
            const page=state.allPagesCheckQueue.shift();
            
            // 更新当前页码
            state.pagination.currentPage=page;
            utils.updateResultsList();
            
            // 获取当前页数据
            const pageData=utils.getCurrentPageData();
            
            // 更新进度显示
            const progressPercent=Math.round((state.allPagesCheckQueue.length)/totalPages*100);
            const currentPercent=100-progressPercent;
            els.progressFill.style.width=`${currentPercent}%`;
            els.checkProgressText.textContent=`第${page}页/${totalPages}页`;
            els.checkDetails.textContent=`正在检测第${page}页，共${pageData.length}个直播源，并发数: ${state.concurrency}个...`;
            
            // 使用并发检测当前页
            const pageResult = await utils.concurrentCheck(pageData, state.checkTimeout, state.concurrency,
                (checked, total, source, checkResult) => {
                    const pageProgressPercent = Math.round(checked / total * 100);
                    els.checkDetails.textContent = `第${page}页: ${checked}/${total} (${pageProgressPercent}%) - ${source.name}: ${checkResult.valid?'有效':'无效'} (${checkResult.time}ms)`;
                }
            );
            
            totalChecked += pageResult.totalChecked;
            totalValid += pageResult.totalValid;
            
            // 检测完一页后，给浏览器喘息的机会
            if(state.allPagesCheckQueue.length>0&&state.checking){
                els.checkDetails.textContent=`第${page}页检测完成，等待3秒后继续下一页...`;
                await new Promise(resolve=>setTimeout(resolve,3000)); // 等待3秒
            }
        }
        
        return {totalChecked,totalValid};
    },
    // 新增：分组检测（并发版本）
    async checkByGroups(){
        if(state.selectedGroups.length===0){
            alert('请先在分组管理中选择要检测的分组！');
            return {totalChecked:0,totalValid:0};
        }
        
        // 获取选中分组的数据
        const groupData=state.data.filter(item=>state.selectedGroups.includes(item.group));
        if(groupData.length===0){
            alert('选中的分组中没有直播源！');
            return {totalChecked:0,totalValid:0};
        }
        
        // 模拟分页检测（按每页10条分组）
        const pageSize=10;
        const totalPages=Math.ceil(groupData.length/pageSize);
        let totalChecked=0,totalValid=0;
        
        for(let page=1;page<=totalPages;page++){
            if(!state.checking)break;
            
            const startIndex=(page-1)*pageSize;
            const endIndex=Math.min(page*pageSize,groupData.length);
            const pageData=groupData.slice(startIndex,endIndex);
            
            // 更新进度显示
            const progressPercent=Math.round((page-1)/totalPages*100);
            els.progressFill.style.width=`${progressPercent}%`;
            els.checkProgressText.textContent=`分组检测 ${page}/${totalPages}`;
            els.checkDetails.textContent=`正在检测分组: ${state.selectedGroups.join(',')} - 第${page}页，共${pageData.length}个直播源，并发数: ${state.concurrency}个...`;
            
            // 使用并发检测当前页数据
            const pageResult = await utils.concurrentCheck(pageData, state.checkTimeout, state.concurrency,
                (checked, total, source, checkResult) => {
                    const pageProgressPercent = Math.round(checked / total * 100);
                    els.checkDetails.textContent = `分组检测: ${checked}/${total} (${pageProgressPercent}%) - ${source.name}: ${checkResult.valid?'有效':'无效'} (${checkResult.time}ms)`;
                }
            );
            
            totalChecked += pageResult.totalChecked;
            totalValid += pageResult.totalValid;
            
            // 检测完一页后，给浏览器喘息的机会
            if(page<totalPages&&state.checking){
                els.checkDetails.textContent=`分组检测第${page}页完成，等待3秒后继续下一页...`;
                await new Promise(resolve=>setTimeout(resolve,3000)); // 等待3秒
            }
        }
        
        return {totalChecked,totalValid};
    },
    // 新增：开始检测
    async startChecking(mode){
        if(state.data.length===0){
            alert('没有可检测的直播源！');
            return;
        }
        
        state.checking=true;
        state.currentCheckMode=mode;
        
        // 更新UI
        els.checkPageBtn.style.display='none';
        els.checkAllBtn.style.display='none';
        els.checkGroupBtn.style.display='none';
        els.stopCheckBtn.style.display='block';
        els.checkProgress.style.display='block';
        els.checkStatusText.textContent='检测中...';
        
        // 重置进度条
        els.progressFill.style.width='0%';
        els.checkProgressText.textContent='准备中...';
        els.checkDetails.textContent='开始检测...';
        
        try{
            let result;
            if(mode==='currentPage'){
                result=await utils.checkCurrentPage();
            }else if(mode==='allPages'){
                result=await utils.checkAllPages();
            }else if(mode==='group'){
                result=await utils.checkByGroups();
            }
            
            // 检测完成
            if(state.checking){
                els.progressFill.style.width='100%';
                els.checkProgressText.textContent='检测完成';
                els.checkDetails.textContent=`检测完成！共检测${result.totalChecked}个直播源，其中${result.totalValid}个有效，${result.totalChecked-result.totalValid}个无效`;
                els.checkStatusText.textContent='检测完成';
                
                // 显示结果摘要
                setTimeout(()=>{
                    alert(`检测完成！\n总计: ${result.totalChecked}个直播源\n有效: ${result.totalValid}个\n无效: ${result.totalChecked-result.totalValid}个\n并发数: ${state.concurrency}个`);
                },500);
            }
        }catch(error){
            console.error('检测过程中出错:',error);
            els.checkDetails.textContent=`检测出错: ${error.message}`;
            els.checkStatusText.textContent='检测出错';
        }finally{
            // 重置状态
            state.checking=false;
            els.checkPageBtn.style.display='block';
            els.checkAllBtn.style.display='block';
            els.checkGroupBtn.style.display='block';
            els.stopCheckBtn.style.display='none';
            els.checkStatusText.textContent='就绪';
            
            // 3秒后隐藏进度条
            setTimeout(()=>{
                if(!state.checking){
                    els.checkProgress.style.display='none';
                }
            },3000);
            
            // 更新结果列表
            utils.updateResultsList();
        }
    },
    // 新增：停止检测
    stopChecking(){
        state.checking=false;
        state.allPagesCheckQueue=[]; // 清空检测队列
        els.checkPageBtn.style.display='block';
        els.checkAllBtn.style.display='block';
        els.checkGroupBtn.style.display='block';
        els.stopCheckBtn.style.display='none';
        els.checkProgressText.textContent='检测已取消';
        els.checkDetails.textContent='用户取消了检测过程';
        els.checkStatusText.textContent='已取消';
    },
    // 新增：获取检测统计
    getCheckStats(){
        let total=0,valid=0,invalid=0,unchecked=0;
        
        state.data.forEach(item=>{
            const status=state.checkStatus[item.url];
            if(status){
                if(status.status==='checked'){
                    total++;
                    if(status.valid)valid++;
                    else invalid++;
                }else{
                    unchecked++;
                }
            }else{
                unchecked++;
            }
        });
        
        return {total,valid,invalid,unchecked};
    },
    // 新增：播放视频（内嵌版本）
    playVideo(url, name){
        state.currentPlayingUrl = url;
        state.currentPlayingName = name;
        state.isVideoPlaying = true;
        
        // 更新视频预览区域标题和URL信息
        els.videoTitle.textContent = name;
        els.videoUrl.textContent = `URL: ${url}`;
        els.videoStatus.textContent = '正在加载...';
        
        // 隐藏占位符，显示加载中
        els.videoPlaceholder.style.display = 'none';
        els.videoLoading.style.display = 'block';
        els.videoPlayer.style.display = 'none';
        
        // 设置视频源
        els.videoSource.src = url;
        els.videoPlayer.load();
        
        // 尝试播放
        const playPromise = els.videoPlayer.play();
        
        if (playPromise !== undefined) {
            playPromise.then(() => {
                // 播放成功，隐藏加载中，显示视频播放器
                els.videoLoading.style.display = 'none';
                els.videoPlayer.style.display = 'block';
                els.videoStatus.textContent = '正在播放';
            }).catch(error => {
                // 播放失败，显示错误信息
                console.error('播放失败:', error);
                els.videoLoading.textContent = '播放失败，请检查格式或网络连接';
                els.videoLoading.style.display = 'block';
                els.videoPlayer.style.display = 'none';
                els.videoStatus.textContent = '播放失败';
            });
        }
    },
    // 新增：关闭视频播放器
    closeVideoPlayer(){
        // 暂停视频
        if(els.videoPlayer){
            els.videoPlayer.pause();
            els.videoPlayer.currentTime = 0;
        }
        
        // 显示占位符，隐藏视频播放器和加载中
        els.videoPlaceholder.style.display = 'block';
        els.videoPlayer.style.display = 'none';
        els.videoLoading.style.display = 'none';
        
        // 重置状态
        state.currentPlayingUrl = '';
        state.currentPlayingName = '';
        state.isVideoPlaying = false;
        els.videoStatus.textContent = '已停止';
        els.videoTitle.textContent = '未选择频道';
        els.videoUrl.textContent = 'URL: 无';
    },
    // 新增：重新加载视频
    reloadVideo(){
        if(state.currentPlayingUrl){
            utils.playVideo(state.currentPlayingUrl, state.currentPlayingName);
        }
    },
    // 新增：停止视频播放
    stopVideo(){
        utils.closeVideoPlayer();
    },
    // 新增：切换筛选
    setFilter(filter){
        state.currentFilter = filter;
        
        // 更新筛选按钮状态
        els.filterAllBtn.classList.remove('active');
        els.filterValidBtn.classList.remove('active');
        els.filterInvalidBtn.classList.remove('active');
        
        if(filter === 'all'){
            els.filterAllBtn.classList.add('active');
        }else if(filter === 'valid'){
            els.filterValidBtn.classList.add('active');
        }else if(filter === 'invalid'){
            els.filterInvalidBtn.classList.add('active');
        }
        
        // 重置到第一页
        state.pagination.currentPage = 1;
        
        // 更新结果列表
        utils.updateResultsList();
    },
    // 新增：全部勾选有效结果
    selectAllValid(){
        const validData = utils.getAllValidData();
        validData.forEach(item => {
            state.selectedValidUrls.add(item.url);
        });
        utils.updateResultsList();
    },
    // 新增：全部取消勾选有效结果
    deselectAllValid(){
        state.selectedValidUrls.clear();
        utils.updateResultsList();
    },
    // 新增：导出勾选的有效结果
    exportValidSelected(){
        // 获取所有勾选的有效源
        const dataToExport = state.data.filter(item => 
            state.selectedValidUrls.has(item.url) && 
            state.checkStatus[item.url] && 
            state.checkStatus[item.url].status === 'checked' && 
            state.checkStatus[item.url].valid === true
        );
        
        if(dataToExport.length === 0) {
            alert('请先勾选要导出的有效直播源！');
            return;
        }
        
        // 按分组组织数据，保持原始导入格式
        const groupMap = new Map();
        const groupOrder = []; // 保持分组顺序
        
        // 首先添加分组信息行
        dataToExport.forEach(item => {
            const group = item.group;
            if(!groupMap.has(group)) {
                groupMap.set(group, []);
                groupOrder.push(group);
            }
            
            // 获取原始导入行，如果存在则使用，否则构建新行
            const originalLine = state.importData.sources[item.url] ? 
                state.importData.sources[item.url].originalLine : 
                `${item.name},${item.url}`;
            groupMap.get(group).push(originalLine);
        });
        
        // 构建导出内容
        const lines = [];
        
        // 按照原始分组顺序添加分组
        groupOrder.forEach(group => {
            // 添加分组标题行
            if(state.importData.groupInfo[group]) {
                // 使用原始分组信息行
                lines.push(state.importData.groupInfo[group]);
            } else if(group !== '默认分组') {
                // 构建新的分组信息行
                lines.push(`${group},#genre#${group}`);
            }
            
            // 添加该分组下的所有频道
            const channels = groupMap.get(group);
            channels.forEach(channel => {
                lines.push(channel);
            });
        });
        
        // 如果没有有效的分组数据，添加默认分组
        if(lines.length === 0) {
            lines.push('默认分组,#genre#默认分组');
        }
        
        const blob = new Blob([lines.join('\n')], {type: 'text/plain;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `有效直播源_${new Date().toISOString().slice(0,10)}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert(`成功导出${dataToExport.length}个有效直播源`);
    },
    // 新增：导出所有有效结果
    exportAllValid(){
        const validData = utils.getAllValidData();
        
        if(validData.length === 0) {
            alert('没有有效的直播源可以导出！');
            return;
        }
        
        // 按分组组织数据，保持原始导入格式
        const groupMap = new Map();
        const groupOrder = []; // 保持分组顺序
        
        // 首先添加分组信息行
        validData.forEach(item => {
            const group = item.group;
            if(!groupMap.has(group)) {
                groupMap.set(group, []);
                groupOrder.push(group);
            }
            
            // 获取原始导入行，如果存在则使用，否则构建新行
            const originalLine = state.importData.sources[item.url] ? 
                state.importData.sources[item.url].originalLine : 
                `${item.name},${item.url}`;
            groupMap.get(group).push(originalLine);
        });
        
        // 构建导出内容
        const lines = [];
        
        // 按照原始分组顺序添加分组
        groupOrder.forEach(group => {
            // 添加分组标题行
            if(state.importData.groupInfo[group]) {
                // 使用原始分组信息行
                lines.push(state.importData.groupInfo[group]);
            } else if(group !== '默认分组') {
                // 构建新的分组信息行
                lines.push(`${group},#genre#${group}`);
            }
            
            // 添加该分组下的所有频道
            const channels = groupMap.get(group);
            channels.forEach(channel => {
                lines.push(channel);
            });
        });
        
        // 如果没有有效的分组数据，添加默认分组
        if(lines.length === 0) {
            lines.push('默认分组,#genre#默认分组');
        }
        
        const blob = new Blob([lines.join('\n')], {type: 'text/plain;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `所有有效直播源_${new Date().toISOString().slice(0,10)}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert(`成功导出${validData.length}个有效直播源`);
    }
};

const fetchUrl=async u=>{const f=utils.fixUrl(u);const c=new AbortController();const t=setTimeout(()=>c.abort(),10000);
try{const r=await fetch(f,{signal:c.signal,headers:{'User-Agent':'Mozilla/5.0'}});clearTimeout(t);if(r.ok)return await r.text();
throw new Error(`HTTP错误:${r.status}`)}catch{clearTimeout(t);try{const p=`https://api.allorigins.win/raw?url=${encodeURIComponent(f)}`;
const r=await fetch(p,{signal:c.signal});if(r.ok)return await r.text();throw new Error('代理服务器错误')}catch{throw new Error('无法访问URL')}}};

const initEvents=()=>{
    els.localImportBtn.onclick=()=>els.fileInput.click();
    els.fileInput.onchange=async e=>{const f=e.target.files[0];if(!f)return;if(!f.name.match(/\.(txt|m3u|m3u8)$/i)){alert('请选择.txt、.m3u或.m3u8格式的文件');return}
    try{const t=await f.text();const s=utils.parseSourceText(t);if(!s.length){alert('未找到有效的直播源');return}
    const r=utils.addSources(s);utils.updateStats();utils.updateResultsList();
    alert(`导入成功，新增${r.added}个直播源${r.duplicates?`，跳过${r.duplicates}个重复项`:''}`);els.fileInput.value=''}catch{alert('文件读取失败')}};
    els.networkImportBtn.onclick=()=>{els.networkUrl.value='';els.networkStatus.style.display='none';els.networkModal.style.display='block';
    setTimeout(()=>els.networkUrl.focus(),300)};
    els.cancelImportBtn.onclick=()=>utils.hideModal('networkModal');
    els.confirmImportBtn.onclick=async()=>{const u=els.networkUrl.value.trim();if(!u){utils.showStatus('请输入URL地址',true);return}
    utils.showLoading(true);els.confirmImportBtn.disabled=true;try{const t=await fetchUrl(u);if(!t||!t.trim().length)throw new Error('文件内容为空');
    const s=utils.parseSourceText(t);if(!s.length)throw new Error('未找到有效的直播源');const r=utils.addSources(s);
    utils.updateStats();utils.updateResultsList();utils.showStatus(`导入成功，新增${r.added}个直播源${r.duplicates?`，跳过${r.duplicates}个重复项`:''}`,false);
    setTimeout(()=>utils.hideModal('networkModal'),2000)}catch(e){utils.showStatus(`导入失败:${e.message}`,true)}finally{utils.showLoading(false);els.confirmImportBtn.disabled=false}};
    els.groupBtn.onclick=()=>{state.selectedGroups=Array.from(state.groups);utils.updateGroupList();els.groupModal.style.display='block'};
    els.groupCheckboxes.onclick=e=>{const g=e.target.closest('.group-item');if(g){const gp=g.getAttribute('data-group');
    const i=state.selectedGroups.indexOf(gp);i>-1?state.selectedGroups.splice(i,1):state.selectedGroups.push(gp);utils.updateGroupList()}};
    els.selectAllGroupsBtn.onclick=()=>{state.selectedGroups=Array.from(state.groups);utils.updateGroupList()};
    els.deselectAllGroupsBtn.onclick=()=>{state.selectedGroups=[];utils.updateGroupList()};
    els.closeGroupBtn.onclick=()=>utils.hideModal('groupModal');
    els.clearBtn.onclick=()=>{if(!state.data.length){alert('没有数据可以清空');return}
    if(confirm(`确定要清空所有${state.data.length}个直播源吗？`)){state.data=[];state.groups.clear();state.importData={groupInfo:{},sources:{}};
    state.selectedGroups=[];state.duplicates=0;state.checkStatus={};state.selectedValidUrls.clear();state.pagination.currentPage=1;utils.updateStats();utils.updateResultsList();alert('已清空所有数据')}};
    els.pageSizeInput.onchange=()=>{let ps=parseInt(els.pageSizeInput.value);if(isNaN(ps)||ps<5)ps=5;else if(ps>100)ps=100;
    state.pagination.pageSize=ps;state.pagination.currentPage=1;utils.updateResultsList()};
    els.pageSizeInput.onkeypress=e=>{if(e.key==='Enter')els.pageSizeInput.blur()};
    els.firstPageBtn.onclick=()=>{if(state.pagination.currentPage>1){state.pagination.currentPage=1;utils.updateResultsList()}};
    els.prevPageBtn.onclick=()=>{if(state.pagination.currentPage>1){state.pagination.currentPage--;utils.updateResultsList()}};
    els.nextPageBtn.onclick=()=>{const p=utils.calculatePagination();if(state.pagination.currentPage<p.totalPages){state.pagination.currentPage++;utils.updateResultsList()}};
    els.lastPageBtn.onclick=()=>{const p=utils.calculatePagination();if(state.pagination.currentPage<p.totalPages){state.pagination.currentPage=p.totalPages;utils.updateResultsList()}};
    els.pageNumbers.onclick=e=>{if(e.target.classList.contains('page-btn')&&!e.target.classList.contains('active')){
    const p=parseInt(e.target.getAttribute('data-page'));if(!isNaN(p)&&p>=1&&p<=state.pagination.totalPages){state.pagination.currentPage=p;utils.updateResultsList()}}};
    document.addEventListener('click',e=>{if(e.target.classList.contains('modal'))e.target.style.display='none'});
    els.networkUrl.onkeypress=e=>{if(e.key==='Enter')els.confirmImportBtn.click()};
    els.clearBtn.oncontextmenu=e=>{e.preventDefault();if(state.duplicates){if(confirm(`检测到${state.duplicates}个重复项，是否删除所有重复项？`)){
    if(utils.removeDuplicates()){utils.updateStats();utils.updateResultsList()}}}else alert('没有检测到重复项')};
    
    // 新增事件监听
    // 超时滑块控制
    els.timeoutSlider.oninput=function(){
        const value=parseInt(this.value);
        state.checkTimeout=value;
        els.timeoutValue.textContent=`${value}秒`;
    };
    
    // 并发滑块控制
    els.concurrencySlider.oninput=function(){
        const value=parseInt(this.value);
        state.concurrency=value;
        els.concurrencyValue.textContent=`${value}个`;
        els.concurrentStatus.textContent=`并发:${value}个`;
    };
    
    // 检测当前页按钮
    els.checkPageBtn.onclick=function(){
        if(!state.checking){
            utils.startChecking('currentPage');
        }
    };
    
    // 检测全部页按钮
    els.checkAllBtn.onclick=function(){
        if(!state.checking){
            utils.startChecking('allPages');
        }
    };
    
    // 分组检测按钮
    els.checkGroupBtn.onclick=function(){
        if(!state.checking){
            utils.startChecking('group');
        }
    };
    
    // 停止检测按钮
    els.stopCheckBtn.onclick=function(){
        if(state.checking){
            utils.stopChecking();
        }
    };
    
    // 取消检测按钮
    els.checkCancelBtn.onclick=function(){
        if(state.checking){
            utils.stopChecking();
        }
    };
    
    // 视频播放器关闭按钮
    els.closeVideoBtn.onclick=function(){
        utils.closeVideoPlayer();
    };
    
    // 重新加载视频按钮
    els.reloadVideoBtn.onclick=function(){
        utils.reloadVideo();
    };
    
    // 停止视频按钮
    els.stopVideoBtn.onclick=function(){
        utils.stopVideo();
    };
    
    // 筛选按钮事件
    els.filterAllBtn.onclick=function(){
        utils.setFilter('all');
    };
    
    els.filterValidBtn.onclick=function(){
        utils.setFilter('valid');
    };
    
    els.filterInvalidBtn.onclick=function(){
        utils.setFilter('invalid');
    };
    
    // 全部勾选有效结果按钮
    els.selectAllValidBtn.onclick=function(){
        utils.selectAllValid();
    };
    
    // 全部取消勾选有效结果按钮
    els.deselectAllValidBtn.onclick=function(){
        utils.deselectAllValid();
    };
    
    // 导出勾选的有效结果按钮
    els.exportValidSelectedBtn.onclick=function(){
        utils.exportValidSelected();
    };
    
    // 勾选框点击事件（事件委托）
    els.resultsList.addEventListener('change', function(e){
        if(e.target.classList.contains('result-checkbox')){
            const url = e.target.getAttribute('data-url');
            const checked = e.target.checked;
            
            if(checked){
                state.selectedValidUrls.add(url);
            }else{
                state.selectedValidUrls.delete(url);
            }
            
            // 更新有效结果统计
            utils.updateResultsList();
        }
    });
    
    // 播放按钮点击事件（事件委托）
    els.resultsList.addEventListener('click', function(e){
        if(e.target.classList.contains('play-btn')){
            const url = e.target.getAttribute('data-url');
            const name = e.target.getAttribute('data-name');
            utils.playVideo(url, name);
        }
    });
    
    // 视频播放器事件
    els.videoPlayer.addEventListener('playing', function(){
        els.videoLoading.style.display = 'none';
        els.videoPlayer.style.display = 'block';
        els.videoStatus.textContent = '正在播放';
    });
    
    els.videoPlayer.addEventListener('waiting', function(){
        els.videoLoading.style.display = 'block';
        els.videoLoading.textContent = '缓冲中...';
        els.videoStatus.textContent = '缓冲中...';
    });
    
    els.videoPlayer.addEventListener('canplay', function(){
        els.videoLoading.style.display = 'none';
        els.videoPlayer.style.display = 'block';
        els.videoStatus.textContent = '准备就绪';
    });
    
    els.videoPlayer.addEventListener('ended', function(){
        els.videoStatus.textContent = '播放结束';
    });
    
    els.videoPlayer.addEventListener('error', function(){
        els.videoLoading.textContent = '播放错误，请检查视频格式或网络连接';
        els.videoLoading.style.display = 'block';
        els.videoPlayer.style.display = 'none';
        els.videoStatus.textContent = '播放错误';
    });
    
    // 更新检测状态文本
    setInterval(() => {
        if(!state.checking){
            const stats = utils.getCheckStats();
            els.checkStatusText.textContent = `已检测: ${stats.valid}有效 ${stats.invalid}无效 ${stats.unchecked}未检`;
        }
    }, 2000);
};

const init=()=>{
    initEvents();
    utils.updateStats();
    utils.updateResultsList();
    // 初始化视频播放器状态
    utils.closeVideoPlayer();
};

document.readyState==='loading'?document.addEventListener('DOMContentLoaded',init):init();
})();
</script>
</body>
</html>
