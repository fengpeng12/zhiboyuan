<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>直播源检测</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background: #fff; }
        .card { background: #f5f5f5; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        h2 { margin: 0 0 15px 0; color: #2c80ff; }
        input, select, button, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        button { background: #2c80ff; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:disabled { background: #ccc; }
        .stats { display: flex; justify-content: space-between; margin-top: 15px; text-align: center; }
        .stat { flex: 1; }
        .stat-value { font-size: 24px; font-weight: bold; color: #2c80ff; }
        .stat-label { font-size: 12px; color: #666; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px; background: #4CAF50; color: white; border-radius: 8px; display: none; }
        
        /* 新增样式 */
        .player-container { margin-top: 20px; padding: 10px; background: #fff; border-radius: 8px; }
        .player-container video { width: 100%; max-height: 300px; border-radius: 8px; }
        .source-list { max-height: 400px; overflow-y: auto; margin: 15px 0; }
        .source-item { display: flex; align-items: center; padding: 10px; margin: 5px 0; background: white; border-radius: 6px; }
        .source-item:hover { background: #f0f8ff; }
        .channel-name { font-weight: bold; font-size: 16px; margin-bottom: 5px; }
        .channel-url { font-size: 12px; color: #666; word-break: break-all; margin-bottom: 5px; }
        .setting-group { display: flex; gap: 15px; margin: 10px 0; }
        .setting-item { flex: 1; }
        .setting-item label { display: block; margin-bottom: 5px; font-weight: bold; }
        .button-group { display: flex; gap: 10px; }
        .progress { background: #e0e0e0; border-radius: 4px; height: 10px; margin: 10px 0; overflow: hidden; }
        .progress-bar { background: #2c80ff; height: 100%; width: 0%; transition: width 0.3s; }
        
        /* 新增的过滤按钮样式 */
        .filter-buttons { display: flex; gap: 10px; margin-bottom: 15px; }
        .filter-btn { padding: 8px 16px; background: #e0e0e0; color: #333; border-radius: 6px; cursor: pointer; font-weight: normal; }
        .filter-btn.active { background: #2c80ff; color: white; }
        
        /* 检测时间样式 */
        .check-time { 
            font-size: 11px; 
            color: #666;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 5px;
            font-family: monospace;
        }
        .check-time.success { background: #e8f5e9; color: #2e7d32; }
        .check-time.failed { background: #ffebee; color: #c62828; }
        .check-time.pending { background: #e3f2fd; color: #1565c0; }
        .right-section { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            flex-shrink: 0;
        }
        
        /* 网络导入样式 */
        .url-import-container { display: flex; gap: 10px; }
        .url-import-container input { flex: 1; }
        .url-import-container button { width: auto; min-width: 120px; }
        .example-links { margin-top: 10px; font-size: 12px; color: #666; }
        .example-link { color: #2c80ff; cursor: pointer; text-decoration: underline; margin: 0 5px; }
        .example-link:hover { color: #1a5bbf; }
        
        /* 状态提示 */
        .loading-indicator { display: none; text-align: center; padding: 10px; color: #2c80ff; }
    </style>
</head>
<body>
    <div class="card">
        <h2>导入直播源</h2>
        <input type="file" id="fileInput" accept=".txt,.m3u">
        <div id="sourceCount">0个频道</div>
    </div>

    <div class="card">
        <h2>网络导入 (支持 Gitee/GitHub 等)</h2>
        <div class="url-import-container">
            <input type="text" id="urlInput" placeholder="输入直播源文件URL (支持.txt/.m3u文件)" value="">
            <button id="urlImportBtn">导入</button>
        </div>
        <div class="example-links">
            示例：
            <span class="example-link" onclick="loadExample('gitee')">Gitee示例</span> | 
            <span class="example-link" onclick="loadExample('direct')">直接URL示例</span>
        </div>
        <div class="loading-indicator" id="loadingIndicator">正在加载...</div>
    </div>

    <div class="card">
        <h2>检测设置</h2>
        <div class="setting-group">
            <div class="setting-item">
                <label>检测时长(秒): <span id="timeoutValue">5</span></label>
                <input type="range" id="timeoutSlider" min="1" max="20" value="5">
            </div>
            <div class="setting-item">
                <label>线程数: <span id="threadValue">5</span></label>
                <input type="range" id="threadSlider" min="1" max="15" value="5">
            </div>
        </div>
        
        <div class="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div id="progressText">等待开始</div>
        
        <div class="button-group">
            <button id="start">开始检测</button>
            <button id="pause" disabled>暂停检测</button>
            <button id="export">导出有效源</button>
        </div>
    </div>

    <div class="card">
        <h2>视频预览</h2>
        <div class="player-container">
            <video id="videoPlayer" controls></video>
        </div>
    </div>

    <div class="card">
        <h2>直播源列表</h2>
        <!-- 新增过滤按钮 -->
        <div class="filter-buttons">
            <button class="filter-btn active" onclick="filterSources('all')">全部</button>
            <button class="filter-btn" onclick="filterSources('online')">在线</button>
            <button class="filter-btn" onclick="filterSources('offline')">离线</button>
        </div>
        
        <div class="source-list" id="sourceList">
            <div style="text-align: center; padding: 20px; color: #999;">暂无直播源</div>
        </div>
        
        <div class="stats">
            <div class="stat"><div class="stat-value" id="total">0</div><div class="stat-label">总数</div></div>
            <div class="stat"><div class="stat-value" id="success">0</div><div class="stat-label">有效</div></div>
            <div class="stat"><div class="stat-value" id="failed">0</div><div class="stat-label">无效</div></div>
            <div class="stat"><div class="stat-value" id="threadActive">0</div><div class="stat-label">活跃线程</div></div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

<script>
let sources = [];
let testing = false;
let paused = false;
let startTime = 0;
let completed = 0;
let valid = [];
let activeThreads = 0;
let timeoutSlider = document.getElementById('timeoutSlider');
let timeoutValue = document.getElementById('timeoutValue');
let threadSlider = document.getElementById('threadSlider');
let threadValue = document.getElementById('threadValue');
let currentFilter = 'all'; // 当前过滤状态

// 清理括号
function cleanBrackets(text) {
    if(!text) return text;
    
    // 移除开头和结尾的中文括号
    if(text.startsWith('（') && text.endsWith('）')) {
        text = text.substring(1, text.length - 1);
    }
    
    // 移除开头和结尾的英文括号
    if(text.startsWith('(') && text.endsWith(')')) {
        text = text.substring(1, text.length - 1);
    }
    
    // 移除开头和结尾的方括号
    if(text.startsWith('[') && text.endsWith(']')) {
        text = text.substring(1, text.length - 1);
    }
    
    // 移除开头和结尾的花括号
    if(text.startsWith('{') && text.endsWith('}')) {
        text = text.substring(1, text.length - 1);
    }
    
    return text.trim();
}

// 从URL提取域名作为名称
function getNameFromUrl(url) {
    try {
        const urlObj = new URL(url);
        const domain = urlObj.hostname.replace('www.', '').split('.')[0];
        return domain.charAt(0).toUpperCase() + domain.slice(1);
    } catch(e) {
        return '未命名频道';
    }
}

// 解析内容 - 支持多种格式
function parseContent(content) {
    sources = [];
    const lines = content.split('\n');
    let currentName = '';
    
    for(let line of lines) {
        line = line.trim();
        if(!line) continue;
        
        // 跳过一些特殊标记行
        if(line.startsWith('#genre') || line.startsWith('#EXTM3U')) continue;
        
        // 处理 #EXTINF 格式
        if(line.startsWith('#EXTINF')) {
            // 尝试提取频道名称
            // 格式: #EXTINF:-1,频道名称
            const match = line.match(/,(.+)$/);
            if(match) {
                currentName = cleanBrackets(match[1]);
            } else {
                currentName = '未命名频道';
            }
            continue;
        }
        
        // 处理包含URL的行
        if(line.includes('://')) {
            let name = '';
            let url = '';
            
            // 查找第一个逗号的位置
            const firstCommaIndex = line.indexOf(',');
            
            if(firstCommaIndex !== -1) {
                // 有逗号，使用第一个逗号作为分隔符
                name = line.substring(0, firstCommaIndex).trim();
                url = line.substring(firstCommaIndex + 1).trim();
                
                // 清理名称中的括号
                name = cleanBrackets(name);
                
                // 如果名称为空，使用当前名称
                if(!name) {
                    name = currentName || '未命名频道';
                }
            } else {
                // 没有逗号，但有URL，使用当前名称
                name = currentName || '未命名频道';
                url = line;
            }
            
            // 如果名称仍然是未命名频道，尝试从URL提取
            if(!name || name === '未命名频道') {
                name = getNameFromUrl(url);
            }
            
            sources.push({
                name: name,
                url: url,
                status: 'pending',
                testing: false,
                checkTime: null
            });
            currentName = '';
            continue;
        }
        
        // 处理纯名称行（不包含://，也不是注释）
        if(!line.startsWith('#')) {
            currentName = cleanBrackets(line);
        }
    }
    
    // 最终检查：确保每个源都有名称
    sources.forEach(source => {
        if(!source.name || source.name === '未命名频道') {
            source.name = getNameFromUrl(source.url);
        }
    });
    
    document.getElementById('sourceCount').textContent = sources.length + '个频道';
    updateStats();
}

// 文件导入
document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        parseContent(e.target.result);
        updateSourceList();
        showMsg(`已导入${sources.length}个频道`);
    };
    reader.readAsText(file);
});

// 网络导入功能
document.getElementById('urlImportBtn').addEventListener('click', async function() {
    const urlInput = document.getElementById('urlInput');
    const url = urlInput.value.trim();
    
    if (!url) {
        showMsg('请输入URL地址', 'error');
        return;
    }
    
    // 验证URL格式
    if (!isValidUrl(url)) {
        showMsg('请输入有效的URL地址', 'error');
        return;
    }
    
    const btn = this;
    const loadingIndicator = document.getElementById('loadingIndicator');
    const originalText = btn.textContent;
    
    btn.textContent = '导入中...';
    btn.disabled = true;
    loadingIndicator.style.display = 'block';
    
    try {
        // 使用简单的CORS代理或直接获取
        const content = await fetchUrlContent(url);
        
        if (content) {
            parseContent(content);
            updateSourceList();
            showMsg(`已从URL导入${sources.length}个频道`);
        } else {
            showMsg('无法获取内容，请检查URL或网络', 'error');
        }
    } catch (error) {
        console.error('导入失败:', error);
        showMsg('导入失败: ' + (error.message || '请检查网络连接'), 'error');
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
        loadingIndicator.style.display = 'none';
    }
});

// 支持URL输入框回车键导入
document.getElementById('urlInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        document.getElementById('urlImportBtn').click();
    }
});

// 加载示例URL
function loadExample(type) {
    const urlInput = document.getElementById('urlInput');
    
    switch(type) {
        case 'gitee':
            // Gitee示例，使用raw.gitee.com
            urlInput.value = 'https://gitee.com/mirrors_iptv/iptv/raw/master/streams/cn.m3u';
            break;
        case 'direct':
            // 直接URL示例
            urlInput.value = 'https://iptv-org.github.io/iptv/countries/cn.m3u';
            break;
    }
}

// 验证URL格式
function isValidUrl(url) {
    try {
        new URL(url);
        return true;
    } catch (error) {
        return false;
    }
}

// 获取URL内容 - 修复CORS问题
async function fetchUrlContent(url) {
    // 尝试不同的方法来获取内容
    const methods = [
        tryDirectFetch,
        tryProxyFetch,
        tryJSONProxy
    ];
    
    for (let method of methods) {
        try {
            const content = await method(url);
            if (content) {
                console.log(`使用 ${method.name} 成功获取内容`);
                return content;
            }
        } catch (error) {
            console.log(`${method.name} 失败:`, error.message);
        }
    }
    
    throw new Error('所有获取方法都失败了');
}

// 方法1: 直接获取
async function tryDirectFetch(url) {
    console.log('尝试直接获取...');
    const response = await fetch(url, {
        method: 'GET',
        mode: 'cors',
        headers: {
            'Accept': 'text/plain,application/x-mpegURL,text/html',
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        }
    });
    
    if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    return await response.text();
}

// 方法2: 使用CORS代理
async function tryProxyFetch(url) {
    console.log('尝试使用CORS代理...');
    // 尝试多个可用的CORS代理
    const proxies = [
        'https://api.allorigins.win/raw?url=',
        'https://corsproxy.io/?',
        'https://api.codetabs.com/v1/proxy?quest='
    ];
    
    for (let proxy of proxies) {
        try {
            const proxyUrl = proxy + encodeURIComponent(url);
            const response = await fetch(proxyUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'text/plain'
                }
            });
            
            if (response.ok) {
                return await response.text();
            }
        } catch (error) {
            console.log(`代理 ${proxy} 失败:`, error.message);
        }
    }
    
    throw new Error('所有代理都失败了');
}

// 方法3: 使用JSON代理
async function tryJSONProxy(url) {
    console.log('尝试使用JSON代理...');
    try {
        const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
        
        if (response.ok) {
            const data = await response.json();
            return data.contents;
        }
    } catch (error) {
        throw new Error('JSON代理失败: ' + error.message);
    }
}

// 过滤源
function filterSources(filterType) {
    currentFilter = filterType;
    
    // 更新按钮状态
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    updateSourceList();
}

// 更新直播源列表
function updateSourceList() {
    const container = document.getElementById('sourceList');
    
    // 根据当前过滤状态筛选源
    let filteredSources = sources;
    if (currentFilter === 'online') {
        filteredSources = sources.filter(source => source.status === 'success');
    } else if (currentFilter === 'offline') {
        filteredSources = sources.filter(source => source.status === 'failed');
    }
    
    if(filteredSources.length === 0) {
        let message = '暂无直播源';
        if (currentFilter === 'online') message = '暂无在线源';
        if (currentFilter === 'offline') message = '暂无离线源';
        container.innerHTML = `<div style="text-align: center; padding: 20px; color: #999;">${message}</div>`;
        return;
    }
    
    container.innerHTML = '';
    filteredSources.forEach((source, index) => {
        // 在原始数组中查找源的实际索引
        const originalIndex = sources.indexOf(source);
        
        const item = document.createElement('div');
        item.className = 'source-item';
        
        let statusColor = '#ccc';
        let statusText = '待检测';
        let timeClass = 'pending';
        
        if(source.status === 'success') {
            statusColor = '#4CAF50';
            statusText = '有效';
            timeClass = 'success';
        } else if(source.status === 'failed') {
            statusColor = '#f44336';
            statusText = '无效';
            timeClass = 'failed';
        } else if(source.testing) {
            statusColor = '#2c80ff';
            statusText = '检测中';
        }
        
        // 格式化检测时间
        let timeDisplay = '--';
        if(source.checkTime !== null) {
            timeDisplay = source.checkTime.toFixed(2) + 's';
        } else if(source.testing) {
            timeDisplay = '检测中...';
        }
        
        item.innerHTML = `
            <div style="width: 20px; height: 20px; border-radius: 50%; background: ${statusColor}; 
                 margin-right: 10px; flex-shrink: 0;"></div>
            <div style="flex: 1; min-width: 0;">
                <div class="channel-name" title="${source.name}">${source.name}</div>
                <div class="channel-url" title="${source.url}">${source.url}</div>
                <div style="display: flex; align-items: center;">
                    <span class="check-time ${timeClass}">检测: ${timeDisplay}</span>
                </div>
            </div>
            <div class="right-section">
                <button style="padding: 8px 12px; font-size: 14px; min-width: 60px;" onclick="playSource(${originalIndex})">播放</button>
                <div style="padding: 8px 12px; color: #666; font-size: 12px; white-space: nowrap;">${statusText}</div>
            </div>
        `;
        container.appendChild(item);
    });
}

// 播放直播源
function playSource(index) {
    const source = sources[index];
    const videoPlayer = document.getElementById('videoPlayer');
    
    videoPlayer.src = source.url;
    videoPlayer.load();
    videoPlayer.play().catch(e => {
        showMsg('播放失败', 'error');
    });
}

// 设置滑块
timeoutSlider.addEventListener('input', function() {
    timeoutValue.textContent = this.value;
});

threadSlider.addEventListener('input', function() {
    threadValue.textContent = this.value;
});

// 开始检测
document.getElementById('start').addEventListener('click', async function() {
    if(sources.length === 0) {
        showMsg('请先导入直播源', 'error');
        return;
    }
    
    if(paused) {
        // 恢复检测
        paused = false;
        document.getElementById('pause').textContent = '暂停检测';
        showMsg('检测已恢复');
        return;
    }
    
    if(testing) {
        showMsg('检测正在进行中', 'error');
        return;
    }
    
    testing = true;
    startTime = Date.now();
    completed = 0;
    valid = [];
    
    // 重置所有状态
    sources.forEach(source => {
        source.status = 'pending';
        source.testing = false;
        source.checkTime = null; // 重置检测时间
    });
    
    // 重置过滤为全部
    currentFilter = 'all';
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector('.filter-btn').classList.add('active');
    
    updateSourceList();
    updateStats();
    
    const btn = this;
    btn.textContent = '检测中...';
    btn.disabled = true;
    document.getElementById('pause').disabled = false;
    
    const total = sources.length;
    const maxThreads = parseInt(threadSlider.value);
    
    // 多线程检测
    const promises = [];
    const queue = [...sources];
    
    // 启动线程
    for(let i = 0; i < Math.min(maxThreads, queue.length); i++) {
        promises.push(worker());
    }
    
    // Worker函数
    async function worker() {
        while(queue.length > 0 && !paused) {
            const source = queue.shift();
            if(!source) break;
            
            const index = sources.indexOf(source);
            if(index === -1) continue;
            
            // 更新状态为检测中
            source.testing = true;
            activeThreads++;
            updateSourceList();
            updateStats();
            
            // 记录检测开始时间
            const checkStartTime = Date.now();
            const result = await testSource(source.url);
            // 计算检测耗时（秒）
            source.checkTime = (Date.now() - checkStartTime) / 1000;
            
            // 更新状态
            source.testing = false;
            source.status = result ? 'success' : 'failed';
            activeThreads--;
            
            if(result) {
                valid.push(source);
            }
            
            completed++;
            updateProgress();
            updateSourceList();
            updateStats();
            
            // 如果暂停则跳出循环
            if(paused) break;
        }
    }
    
    // 等待所有线程完成
    await Promise.all(promises);
    
    // 检测完成或暂停
    if(!paused) {
        testing = false;
        btn.textContent = '开始检测';
        btn.disabled = false;
        document.getElementById('pause').disabled = true;
        
        const time = ((Date.now() - startTime) / 1000).toFixed(1);
        showMsg(`检测完成：${valid.length}个有效源`);
    } else {
        btn.textContent = '继续检测';
        btn.disabled = false;
    }
});

// 暂停检测
document.getElementById('pause').addEventListener('click', function() {
    if(!testing) return;
    
    paused = !paused;
    this.textContent = paused ? '继续检测' : '暂停检测';
    showMsg(paused ? '检测已暂停' : '检测已恢复');
});

// 检测单个直播源
function testSource(url) {
    return new Promise((resolve) => {
        const timeout = parseInt(timeoutSlider.value) * 1000;
        const video = document.createElement('video');
        video.muted = true;
        video.preload = 'auto';
        
        let timer = setTimeout(() => {
            cleanup();
            resolve(false);
        }, timeout);
        
        function cleanup() {
            clearTimeout(timer);
            video.src = '';
            video.load();
            video.remove();
        }
        
        video.onloadeddata = () => {
            cleanup();
            resolve(true);
        };
        
        video.onerror = () => {
            cleanup();
            resolve(false);
        };
        
        video.src = url;
        video.load();
    });
}

// 更新进度
function updateProgress() {
    const percent = Math.round((completed / sources.length) * 100);
    document.getElementById('progressBar').style.width = percent + '%';
    document.getElementById('progressText').textContent = 
        `检测进度: ${completed}/${sources.length} (${percent}%)`;
}

// 更新统计
function updateStats() {
    document.getElementById('total').textContent = sources.length;
    document.getElementById('success').textContent = valid.length;
    document.getElementById('failed').textContent = completed - valid.length;
    document.getElementById('threadActive').textContent = activeThreads;
}

// 导出功能
document.getElementById('export').addEventListener('click', function() {
    if(valid.length === 0) {
        showMsg('没有有效源可导出', 'error');
        return;
    }
    
    let content = '';
    valid.forEach(source => {
        content += `${source.name},${source.url}\n`;
    });
    
    const blob = new Blob([content], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = '有效直播源.txt';
    a.click();
    URL.revokeObjectURL(url);
    showMsg(`已导出${valid.length}个有效源`);
});

// 显示消息
function showMsg(text, type = 'success') {
    const notif = document.getElementById('notification');
    notif.textContent = text;
    notif.style.background = type === 'error' ? '#f44336' : '#4CAF50';
    notif.style.display = 'block';
    setTimeout(() => notif.style.display = 'none', 3000);
}

// 初始化
updateStats();
</script>
</body>
</html>